%%
% In this file 3 games with 4 brokers and 2 providers are simulated
% Qualities of Service providers and B_1 and B_4 are fixed in all the games
% q_3 varies in the games between q_2 and q_4 and  q_2 changes 
% in each game, but fixed within a game
% Qi, ri, Di & SUi are quality, price, demand and profit of S_i
% qi, Pi, di & BUi are quality, price, demand and profit of B_i
%%
clc
clear
cstring = '.+*o';
mx = 70;
mn = 1;
c = .2;
Q1 = 30;
Q2 = 60;
cnt1 = 1;
n = 1;
q1 = 10;
q4 = 90;
k1 = .01265*Q1^1.5;
k2 = .01265*Q2^1.5;

q3h = q4-2;
step = 1;
 
AA = [37,45,65] % values to assign to q2
 for q2 = AA
     clear d1 d2 d3 d4 p1 p2 p3 p4 r1 r2 BU1 BU2 BU3 BU4 SU1 SU2 D1 D2
     for q3 = q2+1:step:q3h
         
         
         
         if abs(q2-Q1)<abs(q2-Q2)&& abs(q3-Q1)<abs(q3-Q2) % if q2 and q3 are closer to Q1 and prefer to buy from S_1
             r1(cnt1) = (2*k1*Q2*(12*q1^3*(2*q2+q3-3*q4)*(q2-q4)*(q3-q4)+q3*(4*q2^3*q3^2+q2^4*(4*q3-3*q4)-12*q2*q3^2*(q3-2*q4)^2+...
                9*q3^2*(q3-2*q4)^2*q4+2*q2^2*q3*(2*q3^2-9*q3*q4+6*q4^2))+q1*(3*q3^2*(q3-9*q4)*(q3-2*q4)^2-...
                3*q2^4*(q3-q4)+2*q2^3*q3*(-7*q3+3*q4)+2*q2*q3^2*(17*q3^2-75*q3*q4+78*q4^2)+8*q2^2*(2*q3^3-3*q3*q4^2))+...
                2*q1^2*(3*q2^3*(q3-q4)+q2*q3*(-19*q3^2+87*q3*q4-84*q4^2)+q2^2*(-19*q3^2+21*q3*q4+6*q4^2)-q3*(q3^3-21*q3^2*q4+...
                66*q3*q4^2-54*q4^3)))+Q1*(mn*Q2*(q3-q4)*(24*q1^3*(2*q2+q3-3*q4)*(q2-q4)+q1*(-6*q2^4+q2^3*(-58*q3+15*q4)+...
                q2^2*q3*(-34*q3+159*q4)+q2*q3*(14*q3^2+33*q3*q4-144*q4^2)+3*q3^2*(4*q3^2-21*q3*q4+24*q4^2))+...
                q2*q3*(11*q2^3+q2*q3*(29*q3-84*q4)+q2^2*(26*q3-15*q4)+3*q3*(2*q3^2-15*q3*q4+24*q4^2))+...
                q1^2*(12*q2^3-q2^2*(13*q3+75*q4)+q3*(-7*q3^2+87*q3*q4-144*q4^2)+q2*(-64*q3^2+132*q3*q4+72*q4^2)))+...
                c*Q2*(-24*q1^4*(2*q2+q3-3*q4)*(q2-q4)*(q3-q4)+q1^3*(q3-q4)*(12*q2^3+4*q2*q3*(14*q3-51*q4)+...
                q2^2*(71*q3-15*q4)+48*Q1*(2*q2+q3-3*q4)*(q2-q4)+q3*(5*q3^2-69*q3*q4+144*q4^2))+...
                q3*(-6*q2^5*(q3-q4)+q2^4*(Q2^2-9*q3^2-2*Q2*q4+8*q3*q4+q4^2)-9*q3^2*q4*(2*q3^3+Q2^2*(q3-2*q4)-9*q3^2*q4-...
                2*Q2*(q3-2*q4)*q4+9*q3*q4^2-2*q4^3)+q2^3*(6*q3^3+Q2^2*(7*q3-3*q4)+20*q3^2*q4-23*q3*q4^2-3*q4^3+...
                2*Q2*q4*(-7*q3+3*q4))-Q1^2*(q2^4+q2^2*q3*(13*q3-15*q4)+q2^3*(7*q3-3*q4)-9*q3^2*(q3-2*q4)*q4+...
                3*q2*q3*(5*q3^2-15*q3*q4+6*q4^2))+3*q2*q3*(6*q3^4-34*q3^3*q4+37*q3^2*q4^2-15*q3*q4^3+6*q4^4+...
                Q2^2*(5*q3^2-15*q3*q4+6*q4^2)-2*Q2*q4*(5*q3^2-15*q3*q4+6*q4^2))+q2^2*q3*(27*q3^3+Q2^2*(13*q3-15*q4)-...
                58*q3^2*q4+46*q3*q4^2-15*q4^3+Q2*(-26*q3*q4+30*q4^2))+2*Q1*(q2^4*(7*q3-6*q4)-2*q2^3*q3*(q3-3*q4)+...
                9*q3^2*q4*(2*q3^2-9*q3*q4+8*q4^2)-6*q2*q3^2*(4*q3^2-21*q3*q4+19*q4^2)+q2^2*(-17*q3^3+15*q3*q4^2)))+...
                q1*(6*q2^5*(q3-q4)+32*q2^4*q3*(q3-q4)+q2^3*(-13*q3^3-39*q3^2*q4+2*Q2*(11*q3-3*q4)*q4+49*q3*q4^2+3*q4^3+...
                Q2^2*(-11*q3+3*q4))+q2^2*q3*(-76*q3^3+135*q3^2*q4+2*Q2*(35*q3-27*q4)*q4-86*q3*q4^2+27*q4^3+...
                Q2^2*(-35*q3+27*q4))+Q1^2*(q2^2*q3*(35*q3-27*q4)+q2^3*(11*q3-3*q4)-3*q3^2*(q3^2+3*q3*q4-12*q4^2)+...
                q2*q3*(29*q3^2-105*q3*q4+36*q4^2))+q2*q3*(-21*q3^4+209*q3^3*q4-257*q3^2*q4^2+105*q3*q4^3-36*q4^4+...
                Q2^2*(-29*q3^2+105*q3*q4-36*q4^2)+2*Q2*q4*(29*q3^2-105*q3*q4+36*q4^2))-4*Q1*(q2^3*q3*(7*q3-3*q4)+...
                3*q2^4*(q3-q4)+q2*q3^2*(-29*q3^2+183*q3*q4-174*q4^2)+q2^2*q3*(-50*q3^2+39*q3*q4+15*q4^2)-...
                3*q3^2*(q3^3-12*q3^2*q4+43*q3*q4^2-36*q4^3))+3*q3^2*(Q2^2*(q3^2+3*q3*q4-12*q4^2)-2*Q2*q4*(q3^2+3*q3*q4-12*q4^2)+...
                q4*(7*q3^3-46*q3^2*q4+51*q3*q4^2-12*q4^3)))-q1^2*(24*q2^4*(q3-q4)+q2^3*(q3^2-31*q3*q4+30*q4^2)+...
                q2^2*(-20*q3^3-4*Q2^2*(7*q3-3*q4)+39*q3^2*q4+8*Q2*(7*q3-3*q4)*q4-31*q3*q4^2+12*q4^3)+...
                q3*(6*q3^4-47*q3^3*q4+59*q3^2*q4^2-18*q4^4+2*Q2^2*(q3^2-9*q4^2)-4*Q2*q4*(q3^2-9*q4^2))+...
                2*Q1^2*(-q3^3+2*q2^2*(7*q3-3*q4)+9*q3*q4^2+q2*(5*q3^2-30*q3*q4+9*q4^2))+q2*(25*q3^4-9*q3^3*q4-...
                58*q3^2*q4^2+60*q3*q4^3-18*q4^4-2*Q2^2*(5*q3^2-30*q3*q4+9*q4^2)+4*Q2*q4*(5*q3^2-30*q3*q4+9*q4^2))...
                -2*Q1*(12*q2^3*(q3-q4)+q2^2*(-125*q3^2+126*q3*q4+15*q4^2)-2*q2*q3*(31*q3^2-192*q3*q4+177*q4^2)+...
                q3*(-5*q3^3+78*q3^2*q4-273*q3*q4^2+216*q4^3))))-(-q3*(q2^2+5*q2*q3-3*q2*q4-3*q3*q4)+...
                q1*(q2*(7*q3-3*q4)-q3*(q3+3*q4)))*(k2*(q2^2+2*q2*q3-2*q1*(2*q2+q3-3*q4)+...
                3*q3*(q3-2*q4))*q4+2*Q2*(-2*q2^2-4*q2*q3+q1*(8*q2+q3-9*q4)-3*q3*(q3-3*q4))*(q3-q4)*mx)))/...
                (3*Q2*(16*q1^3*(2*q2+q3-3*q4)*(q2-q4)*(q3-q4)+q3*(q2^4*(5*q3-4*q4)+...
                2*q2^3*q3*(q3+q4)+q2^2*q3*(-3*q3^2-12*q3*q4+13*q4^2)+3*q3^2*q4*(4*q3^2-17*q3*q4+16*q4^2)-...
                2*q2*q3^2*(8*q3^2-37*q3*q4+35*q4^2))-2*q1*(q2^3*q3*(7*q3-3*q4)+2*q2^4*(q3-q4)+...
                q2*q3^2*(-21*q3^2+111*q3*q4-110*q4^2)+q2^2*q3*(-22*q3^2+13*q3*q4+13*q4^2)+...
                q3^2*(-2*q3^3+25*q3^2*q4-83*q3*q4^2+72*q4^3))+q1^2*(8*q2^3*(q3-q4)+...
                q2^2*(-67*q3^2+70*q3*q4+13*q4^2)-2*q2*q3*(23*q3^2-122*q3*q4+115*q4^2)+...
                q3*(-3*q3^3+54*q3^2*q4-179*q3*q4^2+144*q4^3))));
            
             r2(cnt1) = -(k1*Q2*(6*q1^3*(q3-q4)*(q2^2*(7*q3-3*q4)+q3*q4*(q3+3*q4)-q2*(q3^2+10*q3*q4-3*q4^2))+...
                q3^2*(q2^4*(4*q3-3*q4)-9*q3^2*(q3-2*q4)*q4^2+q2^2*q3*(-20*q3^2+33*q3*q4-15*q4^2)+...
                3*q2*q3*q4*(9*q3^2-19*q3*q4+6*q4^2)+q2^3*(16*q3^2-21*q3*q4+9*q4^2))+...
                q1*q3*(-3*q2^4*(q3-q4)+6*q3^2*(5*q3-9*q4)*q4^2+q2^3*(-35*q3^2+45*q3*q4-18*q4^2)+...
                q2^2*q3*(73*q3^2-129*q3*q4+48*q4^2)+q2*q3*(q3^3-99*q3^2*q4+192*q3*q4^2-54*q4^3))+...
                q1^2*(q2^2*q3*(-89*q3^2+156*q3*q4-51*q4^2)+3*q2^3*(5*q3^2-8*q3*q4+3*q4^2)+...
                q2*q3*(q3^3+126*q3^2*q4-213*q3*q4^2+54*q4^3)+q3^2*(q3^3-6*q3^2*q4-33*q3*q4^2+54*q4^3)))+...
                c*Q1*Q2*(6*q1^4*(q3-q4)*(-q2+q4)*(5*q2*q3+q3^2-q2*q4-5*q3*q4)+...
                q1^3*(q3-q4)*(q3^4+6*q2^3*(6*q3-5*q4)+24*Q1^2*(2*q2+q3-3*q4)*(q2-q4)+...
                24*Q2^2*q3*q4-15*q3^3*q4-72*Q2^2*q4^2-48*Q2*q3*q4^2+108*q3^2*q4^2+144*Q2*q4^3+...
                24*q3*q4^3-72*q4^4+q2^2*(-48*Q2^2+91*q3^2+96*Q2*q4-33*q3*q4-24*q4^2)-...
                2*q2*(-8*q3^3+12*Q2^2*(q3-5*q4)+105*q3^2*q4-24*Q2*(q3-5*q4)*q4+6*q3*q4^2-60*q4^3)-...
                12*Q1*(q2^2*(7*q3-3*q4)+q3*q4*(q3+3*q4)-q2*(q3^2+10*q3*q4-3*q4^2)))-...
                q3*(3*q2^5*q3*(q3-q4)+q2^4*(-9*q3^3+Q2^2*(7*q3-6*q4)+11*q3^2*q4-...
                2*Q2*(7*q3-6*q4)*q4+4*q3*q4^2-6*q4^3)+q2^3*q3*(-3*q3^3-2*Q2^2*(q3-3*q4)-...
                25*q3^2*q4+4*Q2*(q3-3*q4)*q4+22*q3*q4^2+6*q4^3)+2*Q1*q3*(q2^4*(4*q3-3*q4)-...
                9*q3^2*(q3-2*q4)*q4^2+q2^2*q3*(-20*q3^2+33*q3*q4-15*q4^2)+...
                3*q2*q3*q4*(9*q3^2-19*q3*q4+6*q4^2)+q2^3*(16*q3^2-21*q3*q4+9*q4^2))-...
                6*q2*q3^2*(3*q3^3*q4-22*q3*q4^3+19*q4^4+Q2^2*(4*q3^2-21*q3*q4+19*q4^2)-...
                2*Q2*q4*(4*q3^2-21*q3*q4+19*q4^2))+Q1^2*(2*q2^3*q3*(q3-3*q4)+q2^4*(-7*q3+6*q4)-...
                9*q3^2*q4*(2*q3^2-9*q3*q4+8*q4^2)+6*q2*q3^2*(4*q3^2-21*q3*q4+19*q4^2)+...
                q2^2*(17*q3^3-15*q3*q4^2))+q2^2*q3*(9*q3^4-q3^3*q4+q3^2*q4^2-24*q3*q4^3+...
                15*q4^4+Q2^2*(-17*q3^2+15*q4^2)+Q2*(34*q3^2*q4-30*q4^3))+...
                9*q3^2*q4*(Q2^2*(2*q3^2-9*q3*q4+8*q4^2)-2*Q2*q4*(2*q3^2-9*q3*q4+8*q4^2)+...
                q4*(q3^3-9*q3*q4^2+8*q4^3)))+q1^2*(q2^4*(-9*q3^2+6*q3*q4+3*q4^2)-...
                q2^3*(q3-q4)*(12*Q2^2+47*q3^2-24*Q2*q4-84*q3*q4+12*q4^2)+...
                q2*q3*(-23*q3^4+261*q3^3*q4-208*q3^2*q4^2-384*q3*q4^3+354*q4^4-...
                4*Q2*q4*(31*q3^2-192*q3*q4+177*q4^2)+Q2^2*(62*q3^2-384*q3*q4+354*q4^2))+...
                q2^2*(-101*q3^4+159*q3^3*q4+11*q3^2*q4^2-54*q3*q4^3-15*q4^4+...
                Q2^2*(125*q3^2-126*q3*q4-15*q4^2)+Q2*(-250*q3^2*q4+252*q3*q4^2+30*q4^3))-...
                2*Q1*(q2^2*q3*(-89*q3^2+156*q3*q4-51*q4^2)+3*q2^3*(5*q3^2-8*q3*q4+3*q4^2)+...
                q2*q3*(q3^3+126*q3^2*q4-213*q3*q4^2+54*q4^3)+q3^2*(q3^3-6*q3^2*q4-33*q3*q4^2+54*q4^3))+...
                Q1^2*(12*q2^3*(q3-q4)+q2^2*(-125*q3^2+126*q3*q4+15*q4^2)-...
                2*q2*q3*(31*q3^2-192*q3*q4+177*q4^2)+q3*(-5*q3^3+78*q3^2*q4-273*q3*q4^2+216*q4^3))+...
                q3*(Q2^2*(5*q3^3-78*q3^2*q4+273*q3*q4^2-216*q4^3)+...
                2*Q2*q4*(-5*q3^3+78*q3^2*q4-273*q3*q4^2+216*q4^3)+...
                q4*(19*q3^4-142*q3^3*q4+66*q3^2*q4^2+273*q3*q4^3-216*q4^4)))+q1*(3*q2^5*q3*(q3-q4)+...
                q2^4*(q3-q4)*(6*Q2^2+q3^2-12*Q2*q4+6*q3*q4+6*q4^2)+2*q2^3*q3*(2*q3^3+Q2^2*(7*q3-3*q4)-...
                45*q3^2*q4+46*q3*q4^2-3*q4^3+2*Q2*q4*(-7*q3+3*q4))+q2^2*q3*(55*q3^4-72*q3^3*q4-...
                19*q3^2*q4^2+6*q3*q4^3+30*q4^4-4*Q2*q4*(-50*q3^2+39*q3*q4+15*q4^2)+...
                Q2^2*(-100*q3^2+78*q3*q4+30*q4^2))+q2*q3^2*(9*q3^4-119*q3^3*q4+80*q3^2*q4^2+...
                378*q3*q4^3-348*q4^4+Q2^2*(-58*q3^2+366*q3*q4-348*q4^2)+...
                4*Q2*q4*(29*q3^2-183*q3*q4+174*q4^2))+2*Q1*q3*(3*q2^4*(q3-q4)+...
                6*q3^2*q4^2*(-5*q3+9*q4)+q2^2*q3*(-73*q3^2+129*q3*q4-48*q4^2)+...
                q2^3*(35*q3^2-45*q3*q4+18*q4^2)-q2*q3*(q3^3-99*q3^2*q4+192*q3*q4^2-54*q4^3))-...
                2*Q1^2*(q2^3*q3*(7*q3-3*q4)+3*q2^4*(q3-q4)+q2*q3^2*(-29*q3^2+183*q3*q4-174*q4^2)+...
                q2^2*q3*(-50*q3^2+39*q3*q4+15*q4^2)-3*q3^2*(q3^3-12*q3^2*q4+43*q3*q4^2-36*q4^3))-...
                3*q3^2*(2*Q2^2*(q3^3-12*q3^2*q4+43*q3*q4^2-36*q4^3)-4*Q2*q4*...
                (q3^3-12*q3^2*q4+43*q3*q4^2-36*q4^3)+q4*(3*q3^4-21*q3^3*q4+4*q3^2*q4^2+86*q3*q4^3-...
                72*q4^4))))+Q1*(mn*Q2*(q3-q4)*(q1*(6*q3^3*q4^2+q2^3*q3*(-35*q3+6*q4)+q2^4*...
                (-9*q3+6*q4)+q2*q3^2*(q3^2-18*q3*q4-30*q4^2)+q2^2*q3*(7*q3^2+78*q3*q4-12*q4^2))+...
                6*q1^3*(q2^2*(9*q3-5*q4)+q3*q4*(3*q3+q4)+q2*(-3*q3^2-10*q3*q4+5*q4^2))+...
                q2*q3*(q2^3*(13*q3-6*q4)+q2^2*q3*(10*q3-3*q4)+3*q3^2*q4*(-3*q3+10*q4)+...
                q2*q3*(13*q3^2-54*q3*q4+6*q4^2))+q1^2*(q2^3*(9*q3-3*q4)+q2*q3*...
                (q3^2+87*q3*q4-30*q4^2)+2*q3^2*(2*q3^2-9*q3*q4-6*q4^2)+q2^2*...
                (-50*q3^2+6*q3*q4+6*q4^2)))+2*k2*q4*(12*q1^3*(2*q2+q3-3*q4)*...
                (q2-q4)*(q3-q4)+q3*(4*q2^3*q3^2+q2^4*(4*q3-3*q4)-12*q2*q3^2*(q3-2*q4)^2+...
                9*q3^2*(q3-2*q4)^2*q4+2*q2^2*q3*(2*q3^2-9*q3*q4+6*q4^2))+...
                q1*(3*q3^2*(q3-9*q4)*(q3-2*q4)^2-3*q2^4*(q3-q4)+2*q2^3*q3*(-7*q3+3*q4)+...
                2*q2*q3^2*(17*q3^2-75*q3*q4+78*q4^2)+8*q2^2*(2*q3^3-3*q3*q4^2))+...
                2*q1^2*(3*q2^3*(q3-q4)+q2*q3*(-19*q3^2+87*q3*q4-84*q4^2)+...
                q2^2*(-19*q3^2+21*q3*q4+6*q4^2)-q3*(q3^3-21*q3^2*q4+66*q3*q4^2-54*q4^3)))+...
                Q2*(q3-q4)*(-24*q1^3*(4*q2-q3-3*q4)*(q2-q4)*(q3-q4)+q3*(-6*q2*q3^2*...
                (7*q3-17*q4)*q4+9*q3^2*(3*q3-8*q4)*q4^2+q2^4*(-17*q3+12*q4)+...
                q2^3*(-26*q3^2+6*q3*q4)+q2^2*q3*(7*q3^2+24*q3*q4-21*q4^2))+...
                2*q1*(5*q2^3*q3*(7*q3-3*q4)+6*q2^4*(q3-q4)+q2^2*q3*(-40*q3^2+39*q3*q4+21*q4^2)+...
                3*q3^2*q4*(q3^2-17*q3*q4+36*q4^2)-q2*q3^2*(q3^2-87*q3*q4+186*q4^2))-...
                q1^2*(24*q2^3*(q3-q4)+2*q2*q3*(q3^2+138*q3*q4-219*q4^2)+...
                q2^2*(-139*q3^2+198*q3*q4+21*q4^2)+q3*(5*q3^3-18*q3^2*q4-123*q3*q4^2+216*q4^3)))*mx))/...
                (3*Q1*q4*(-16*q1^3*(2*q2+q3-3*q4)*(q2-q4)*(q3-q4)+q3*(-2*q2^3*q3*(q3+q4)+...
                q2^4*(-5*q3+4*q4)+q2^2*q3*(3*q3^2+12*q3*q4-13*q4^2)-3*q3^2*q4*...
                (4*q3^2-17*q3*q4+16*q4^2)+2*q2*q3^2*(8*q3^2-37*q3*q4+35*q4^2))+...
                q1^2*(-8*q2^3*(q3-q4)+q2^2*(67*q3^2-70*q3*q4-13*q4^2)+2*q2*q3*...
                (23*q3^2-122*q3*q4+115*q4^2)+q3*(3*q3^3-54*q3^2*q4+179*q3*q4^2-144*q4^3))+...
                2*q1*(q2^3*q3*(7*q3-3*q4)+2*q2^4*(q3-q4)+q2*q3^2*(-21*q3^2+111*q3*q4-110*q4^2)+...
                q2^2*q3*(-22*q3^2+13*q3*q4+13*q4^2)+q3^2*(-2*q3^3+25*q3^2*q4-83*q3*q4^2+72*q4^3))));
            
            if q3/Q1*r1(cnt1)+c*(q3-Q1)^2>q3/Q2*r2(cnt1)+c*(q3-Q2)^2 % Violation of price constraint
                eps = 1;
                
                r1(cnt1) = (Q1*(c*Q2*(q2^2*Q2^2*q3+2*q2*Q2^2*q3^2-3*q2^2*q3^3+3*Q2^2*q3^3-3*q2*q3^4-...
                    Q1^2*(q2^2+2*q2*q3+3*q3*(q3-2*q4))*(q3-2*q4)+q1^2*(q2-q3)*q3*(q3-q4)-...
                    2*q2^2*Q2^2*q4+2*q2^2*Q2*q3*q4-4*q2*Q2^2*q3*q4+2*q2^2*q3^2*q4+...
                    4*q2*Q2*q3^2*q4-12*Q2^2*q3^2*q4+q2*q3^3*q4+6*Q2*q3^3*q4+3*q3^4*q4+...
                    q2^2*q3*q4^2+12*Q2^2*q3*q4^2+2*q2*q3^2*q4^2-12*Q2*q3^2*q4^2+...
                    3*q3^3*q4^2-6*q3^2*q4^3+2*Q1*q3*(q2*q3*(5*q3-7*q4)+q2^2*(q3-2*q4)+...
                    3*q3*q4*(-3*q3+4*q4))+2*q1*(-Q2^2*q3^2+Q1^2*(2*q2+q3-3*q4)*(q3-2*q4)+...
                    q2^2*q3*(q3-q4)+5*Q2^2*q3*q4-2*Q2*q3^2*q4-2*q3^3*q4-6*Q2^2*q4^2+...
                    6*Q2*q3*q4^2-q3^2*q4^2+3*q3*q4^3+Q1*q3*(-7*q2*q3+q3^2+11*q2*q4+...
                    7*q3*q4-12*q4^2)-2*q2*(-q3^3+Q2^2*(q3-2*q4)+2*Q2*q3*q4+q3*q4^2)))+...
                    q3*(mn*(q1-q2)*Q2*(q2-q3)*(q3-q4)-k2*(q2^2+2*q2*q3-2*q1*(2*q2+q3-3*q4)+...
                    3*q3*(q3-2*q4))*q4-2*Q2*(q3-q4)*(-q2^2-2*q2*q3+q1*(4*q2-q3-3*q4)+3*q3*q4)*mx)))/...
                    (Q2*q3*(q2*q3*(5*q3-7*q4)+q2^2*(q3-2*q4)+3*q3*q4*...
                    (-3*q3+4*q4)+q1*(-7*q2*q3+q3^2+11*q2*q4+7*q3*q4-12*q4^2)))-eps;
                
                r2(cnt1) = (-mn*Q1*(q1-q2)*Q2*(q2-q3)*(q3-q4)-4*k2*q1*Q1*q2*q4+k2*Q1*q2^2*...
                    q4-2*k2*q1*Q1*q3*q4+2*k2*Q1*q2*q3*q4+3*k2*Q1*q3^2*q4+6*k2*q1*Q1*...
                    q4^2-6*k2*Q1*q3*q4^2-c*Q1*Q2*(q2^2*Q2^2+2*q2*Q2^2*q3-3*q2^2*...
                    q3^2+3*Q2^2*q3^2-3*q2*q3^3-Q1^2*(q2^2+2*q2*q3+...
                    3*q3*(q3-2*q4))+q1^2*(q2-q3)*(q3-q4)-2*q2^2*Q2*q4+...
                    2*q2^2*q3*q4-4*q2*Q2*q3*q4-6*Q2^2*q3*q4+q2*q3^2*q4-6*Q2*q3^2*...
                    q4+3*q3^3*q4+q2^2*q4^2+2*q2*q3*q4^2+12*Q2*q3*q4^2+3*q3^2*...
                    q4^2-6*q3*q4^3+2*Q1*q3*(q2^2+5*q2*q3-3*q2*q4-3*q3*q4)+...
                    2*q1*(-Q2^2*q3+Q1^2*(2*q2+q3-3*q4)+q2^2*(q3-q4)+...
                    3*Q2^2*q4+2*Q2*q3*q4-2*q3^2*q4-6*Q2*q4^2-q3*q4^2+...
                    3*q4^3+Q1*(-7*q2*q3+q3^2+3*q2*q4+3*q3*q4)-2*q2*...
                    (Q2^2-q3^2-2*Q2*q4+q4^2)))-7*q1*q2*Q2*q3*r1(cnt1)+q2^2*...
                    Q2*q3*r1(cnt1)+q1*Q2*q3^2*r1(cnt1)+5*q2*Q2*q3^2*r1(cnt1)+3*q1*q2*Q2*q4*r1(cnt1)+...
                    3*q1*Q2*q3*q4*r1(cnt1)-3*q2*Q2*q3*q4*r1(cnt1)-3*Q2*q3^2*q4*r1(cnt1)+8*q1...
                    *Q1*q2*Q2*q3*mx-2*Q1*q2^2*Q2*q3*mx-2*q1*Q1*Q2*q3^2*mx-...
                    4*Q1*q2*Q2*q3^2*mx-8*q1*Q1*q2*Q2*q4*mx+2*Q1*q2^2*Q2*q4*mx-...
                    4*q1*Q1*Q2*q3*q4*mx+4*Q1*q2*Q2*q3*q4*mx+6*Q1*Q2*q3^2*q4*mx+...
                    6*q1*Q1*Q2*q4^2*mx-6*Q1*Q2*q3*q4^2*mx)/...
                    (2*Q1*(q2^2+2*q2*q3-2*q1*(2*q2+q3-3*q4)+3*q3*(q3-2*q4))*q4);
                
                

                
            end
            
            
             p1(cnt1) = -(2*mn*Q1*(q1-q2)*Q2*(-q3*(q3-4*q4)+3*q1*(q2-q4)-q2*(2*q3+q4))+c*Q1*Q2*...
                (-Q1^2*(2*q2^2+7*q2*q3+3*q3*(q3-4*q4))+2*Q1*q2*q3*(5*q2+q3-6*q4)+6*q1^3*...
                (q2-q4)-2*q1^2*(q3*(q3-4*q4)+6*Q1*(q2-q4)+q2*(2*q3+q4))+q1*...
                (3*q2^3+Q1^2*(11*q2+q3-12*q4)-2*Q1*(q2-q3)*(3*q2+2*q3-6*q4)+...
                q2^2*(q3-4*q4)+q2*(Q2^2+2*q3^2-2*Q2*q4+q4^2)-q3*(Q2^2-2*Q2*q4+2*q3*q4+q4^2))+...
                q2*(-3*q2^2*q3-q2*(Q2^2+3*q3^2-2*Q2*q4-4*q3*q4+q4^2)+q3*(Q2^2-2*Q2*q4+q4*(2*q3+q4))))+...
                6*q1^2*q2*Q2*r1(cnt1)+3*q1*q2^2*Q2*r1(cnt1)-q1*q2*Q2*q3*r1(cnt1)-5*q2^2*Q2*q3*r1(cnt1)-2*q1*Q2*q3^2*...
                r1(cnt1)-q2*Q2*q3^2*r1(cnt1)-6*q1^2*Q2*q4*r1(cnt1)-6*q1*q2*Q2*q4*r1(cnt1)+6*q1*Q2*q3*q4*r1(cnt1)+6*q2*Q2*...
                q3*q4*r1(cnt1)+q1*Q1*q2*q4*r2(cnt1)-Q1*q2^2*q4*r2(cnt1)-q1*Q1*q3*q4*r2(cnt1)+Q1*q2*q3*q4*r2(cnt1)-q1*Q1*...
                q2*Q2*q3*mx+Q1*q2^2*Q2*q3*mx+q1*Q1*Q2*q3^2*mx-Q1*q2*Q2*q3^2*mx+q1*Q1*q2*Q2*q4*mx-...
                Q1*q2^2*Q2*q4*mx-q1*Q1*Q2*q3*q4*mx+Q1*q2*Q2*q3*q4*mx)/...
                (3*Q1*Q2*(-4*q1*q2+q2^2+2*q2*q3+q3^2+4*q1*q4-4*q3*q4));


             p2(cnt1) = -(mn*Q1*(q1-q2)*Q2*(q2-q3)*(3*q2+q3-4*q4)+c*Q1*Q2*(-Q1^2*(q2^2+8*q2*q3+3*...
                q3*(q3-4*q4))+4*Q1*q2*q3*(5*q2+q3-6*q4)+q1^2*(q2-q3)*(3*q2+q3-4*q4)+2*q1*...
                (3*q2^3+Q1*(-9*q2^2+q3^2-4*q2*(q3-3*q4))+Q1^2*(5*q2+q3-6*q4)+q2^2*(q3-4*q4)+...
                q2*(Q2^2+2*q3^2-2*Q2*q4+q4^2)-q3*(Q2^2-2*Q2*q4+2*q3*q4+q4^2))+2*q2*...
                (-3*q2^2*q3-q2*(Q2^2+3*q3^2-2*Q2*q4-4*q3*q4+q4^2)+q3*...
                (Q2^2-2*Q2*q4+q4*(2*q3+q4))))+9*q1*q2^2*Q2*r1(cnt1)+4*q1*q2*Q2*q3*r1(cnt1)-...
                10*q2^2*Q2*q3*r1(cnt1)-q1*Q2*q3^2*r1(cnt1)-2*q2*Q2*q3^2*r1(cnt1)-12*q1*q2*Q2*q4*r1(cnt1)+...
                12*q2*Q2*q3*q4*r1(cnt1)+2*q1*Q1*q2*q4*r2(cnt1)-2*Q1*q2^2*q4*r2(cnt1)-...
                2*q1*Q1*q3*q4*r2(cnt1)+2*Q1*q2*q3*q4*r2(cnt1)-2*q1*Q1*q2*Q2*q3*mx+2*Q1*q2^2*...
                Q2*q3*mx+2*q1*Q1*Q2*q3^2*mx-2*Q1*q2*Q2*q3^2*mx+2*q1*Q1*q2*...
                Q2*q4*mx-2*Q1*q2^2*Q2*q4*mx-2*q1*Q1*Q2*q3*q4*mx+2*Q1*q2*Q2*q3*q4*mx)/...
                (3*Q1*Q2*(-4*q1*q2+q2^2+2*q2*q3+q3^2+4*q1*q4-4*q3*q4));

             p3(cnt1) = -(2*mn*Q1*(q1-q2)*Q2*(q2-q3)*(q3-q4)+c*Q1*Q2*(-q2^2*Q2^2-2*q2*Q2^2*q3-...
                6*q2^2*q3^2+3*Q2^2*q3^2-6*q2*q3^3-2*Q1^2*(q2^2+2*q2*q3+3*q3*(q3-2*q4))+...
                2*q1^2*(q2-q3)*(q3-q4)+2*q2^2*Q2*q4+4*q2^2*q3*q4+4*q2*Q2*q3*q4+...
                2*q2*q3^2*q4-6*Q2*q3^2*q4+6*q3^3*q4-q2^2*q4^2-2*q2*q3*q4^2+3*q3^2*q4^2+...
                4*Q1*q3*(q2^2+5*q2*q3-3*q2*q4-3*q3*q4)+4*q1*(Q1^2*(2*q2+q3-3*q4)+...
                q2^2*(q3-q4)+Q1*(-7*q2*q3+q3^2+3*q2*q4+3*q3*q4)+q2*(Q2^2+2*q3^2-...
                2*Q2*q4+q4^2)-q3*(Q2^2-2*Q2*q4+2*q3*q4+q4^2)))+14*q1*q2*Q2*q3*r1(cnt1)-...
                2*q2^2*Q2*q3*r1(cnt1)-2*q1*Q2*q3^2*r1(cnt1)-10*q2*Q2*q3^2*r1(cnt1)-6*q1*q2*Q2*q4*r1(cnt1)-...
                6*q1*Q2*q3*q4*r1(cnt1)+6*q2*Q2*q3*q4*r1(cnt1)+6*Q2*q3^2*q4*r1(cnt1)+4*q1*Q1*q2*q4*r2(cnt1)-...
                Q1*q2^2*q4*r2(cnt1)-4*q1*Q1*q3*q4*r2(cnt1)-2*Q1*q2*q3*q4*r2(cnt1)+3*Q1*q3^2*q4*r2(cnt1)-...
                4*q1*Q1*q2*Q2*q3*mx+Q1*q2^2*Q2*q3*mx+4*q1*Q1*Q2*q3^2*mx+2*Q1*q2*Q2*q3^2*mx-...
                3*Q1*Q2*q3^3*mx+4*q1*Q1*q2*Q2*q4*mx-Q1*q2^2*Q2*q4*mx-4*q1*Q1*Q2*q3*q4*mx-...
                2*Q1*q2*Q2*q3*q4*mx+3*Q1*Q2*q3^2*q4*mx)/...
                (3*Q1*Q2*(-4*q1*q2+q2^2+2*q2*q3+q3^2+4*q1*q4-4*q3*q4));

             p4(cnt1) = -(mn*Q1*(q1-q2)*Q2*(q2-q3)*(q3-q4)+c*Q1*Q2*(-2*q2^2*Q2^2-4*q2*Q2^2*q3-...
                3*q2^2*q3^2-3*q2*q3^3-Q1^2*(q2^2+2*q2*q3+3*q3*(q3-2*q4))+...
                q1^2*(q2-q3)*(q3-q4)+4*q2^2*Q2*q4+2*q2^2*q3*q4+8*q2*Q2*q3*q4+...
                6*Q2^2*q3*q4+q2*q3^2*q4+3*q3^3*q4-2*q2^2*q4^2-4*q2*q3*q4^2-...
                12*Q2*q3*q4^2+6*q3*q4^3+2*Q1*q3*(q2^2+5*q2*q3-3*q2*q4-3*q3*q4)+...
                2*q1*(-Q2^2*q3+Q1^2*(2*q2+q3-3*q4)+q2^2*(q3-q4)-3*Q2^2*q4+2*Q2*q3*q4-...
                2*q3^2*q4+6*Q2*q4^2-q3*q4^2-3*q4^3+Q1*(-7*q2*q3+q3^2+3*q2*q4+3*q3*q4)+...
                2*q2*(2*Q2^2+q3^2-4*Q2*q4+2*q4^2)))+7*q1*q2*Q2*q3*r1(cnt1)-q2^2*Q2*q3*r1(cnt1)-...
                q1*Q2*q3^2*r1(cnt1)-5*q2*Q2*q3^2*r1(cnt1)-3*q1*q2*Q2*q4*r1(cnt1)-3*q1*Q2*q3*q4*r1(cnt1)+...
                3*q2*Q2*q3*q4*r1(cnt1)+3*Q2*q3^2*q4*r1(cnt1)+8*q1*Q1*q2*q4*r2(cnt1)-2*Q1*q2^2*q4*r2(cnt1)-...
                2*q1*Q1*q3*q4*r2(cnt1)-4*Q1*q2*q3*q4*r2(cnt1)-6*q1*Q1*q4^2*r2(cnt1)+6*Q1*q3*q4^2*r2(cnt1)-...
                8*q1*Q1*q2*Q2*q3*mx+2*Q1*q2^2*Q2*q3*mx+2*q1*Q1*Q2*q3^2*mx+4*Q1*q2*Q2*q3^2*mx+...
                8*q1*Q1*q2*Q2*q4*mx-2*Q1*q2^2*Q2*q4*mx+4*q1*Q1*Q2*q3*q4*mx-4*Q1*q2*Q2*q3*q4*mx-...
                6*Q1*Q2*q3^2*q4*mx-6*q1*Q1*Q2*q4^2*mx+6*Q1*Q2*q3*q4^2*mx)/...
                (3*Q1*Q2*(-4*q1*q2+q2^2+2*q2*q3+q3^2+4*q1*q4-4*q3*q4));
             d1(cnt1) = (((p2(cnt1)-p1(cnt1))/(q2-q1))-mn)/(mx-mn);
             d2(cnt1) = (((p3(cnt1)-p2(cnt1))/(q3-q2))-((p2(cnt1)-p1(cnt1))/(q2-q1)))/(mx-mn);
             d3(cnt1) = (((p4(cnt1)-p3(cnt1))/(q4-q3)) - ((p3(cnt1)-p2(cnt1))/(q3-q2)))/(mx-mn);
             d4(cnt1) = (mx - ((p4(cnt1)-p3(cnt1))/(q4-q3)))/(mx-mn);
             D1(cnt1) = d1(cnt1)+d2(cnt1)+d3(cnt1);
             D2(cnt1)= d4(cnt1);
             BU1(cnt1) = d1(cnt1)*(p1(cnt1)-(q1/Q1*r1(cnt1)+c*(q1-Q1)^2));
             BU2(cnt1) = d2(cnt1)*(p2(cnt1)-(q2/Q1*r1(cnt1)+c*(q2-Q1)^2));
             BU3(cnt1) = d3(cnt1)*(p3(cnt1)-(q3/Q1*r1(cnt1)+c*(q3-Q1)^2));
             BU4(cnt1) = d4(cnt1)*(p4(cnt1)-(q4/Q2*r2(cnt1)+c*(q4-Q2)^2));
             SU1(cnt1) = (d1(cnt1)*q1/Q1+d2(cnt1)*q2/Q1+d3(cnt1)*q3/Q1)*(r1(cnt1)-k1);
             SU2(cnt1) = (d4(cnt1)*q4/Q2)*(r2(cnt1)-k2);

             
         elseif abs(q2-Q1)<abs(q2-Q2)&& abs(q3-Q1)>=abs(q3-Q2) % q2 is closer to Q1 and q3 is closer to Q2
             r1(cnt1) = (2*k1*Q2*(12*q1^3*(q2-q4)*(2*q2^3*(q3-q4)-6*q2*q3*q4^2+3*q3^2*q4^2+...
                q2^2*(-2*q3^2+2*q3*q4+3*q4^2))+q2*q3*(3*q2^5*(q3-q4)-9*q2^4*q3*q4-...
                6*q2^2*q3^2*q4*(2*q3+q4)-3*q3^3*q4*(q3^2-2*q3*q4-8*q4^2)+...
                2*q2^3*q3*(5*q3^2+2*q3*q4+11*q4^2)+3*q2*q3^2*...
                (q3^3-3*q3^2*q4-2*q3*q4^2-8*q4^3))-q1*(9*q2^5*q3*(q3-2*q4)+3*q2^6*...
                (q3-q4)+3*q2*q3^4*(q3^2-6*q3*q4-10*q4^2)-3*q3^4*q4*(q3^2-2*q3*q4-8*q4^2)+...
                3*q2^4*q3*(4*q3^2+5*q3*q4+12*q4^2)-2*q2^3*q3^2*(2*q3^2+26*q3*q4+17*q4^2)+...
                3*q2^2*q3^2*(3*q3^3+5*q3^2*q4+18*q3*q4^2-8*q4^3))+2*q1^2*...
                (3*q2^5*(q3-q4)+6*q3^3*q4^2*(q3+5*q4)-3*q2^4*(q3^2-5*q3*q4-2*q4^2)-...
                6*q2*q3^2*q4*(3*q3^2+7*q3*q4+8*q4^2)-3*q2^3*q3*(q3^2+9*q3*q4+14*q4^2)+...
                q2^2*q3*(11*q3^3+17*q3^2*q4+80*q3*q4^2+18*q4^3)))+Q1*(mn*Q2*(q2-q3)*...
                (24*q1^3*(q2-q4)*(2*q2^2*(q3-q4)+3*q2*q4^2-3*q3*q4^2)+...
                2*q2*q3*(3*q2^4*(q3-q4)+5*q2^3*(q3-q4)^2-3*q3^2*q4*(q3^2-2*q3*q4-8*q4^2)+...
                3*q2^2*q3*(3*q3^2-2*q3*q4+8*q4^2)+3*q2*q3*(q3^3-6*q3^2*q4-5*q3*q4^2-8*q4^3))+...
                q1*(-6*q2^5*(q3-q4)+q2^3*q3*(-26*q3^2+16*q3*q4-107*q4^2)-12*q3^3*q4*...
                (q3^2-2*q3*q4-8*q4^2)-3*q2^4*(10*q3^2-12*q3*q4+5*q4^2)+3*q2*q3^2*...
                (4*q3^3-18*q3^2*q4-31*q3*q4^2-72*q4^3)+3*q2^2*q3*...
                (6*q3^3+24*q3^2*q4+53*q3*q4^2+40*q4^3))+q1^2*(12*q2^4*(q3-q4)-...
                21*q3^2*q4^2*(q3+8*q4)+q2^3*(-12*q3^2+36*q3*q4+75*q4^2)+...
                3*q2*q3*q4*(28*q3^2+51*q3*q4+80*q4^2)-q2^2*...
                (56*q3^3-4*q3^2*q4+263*q3*q4^2+72*q4^3)))+c*Q2*(24*q1^4*(q2-q4)*...
                (-2*q2^3*(q3-q4)+6*q2*q3*q4^2-3*q3^2*q4^2+q2^2*(2*q3^2-2*q3*q4-3*q4^2))+...
                q1^3*(q2-q3)*(12*q2^4*(q3-q4)+15*q3^2*q4^2*(q3+8*q4)+3*q2^3*...
                (12*q3^2-20*q3*q4+5*q4^2)-3*q2*q3*q4*(20*q3^2+33*q3*q4+40*q4^2)+...
                q2^2*q3*(40*q3^2-44*q3*q4+157*q4^2)+48*Q1*(q2-q4)*...
                (2*q2^2*(q3-q4)+3*q2*q4^2-3*q3*q4^2))-2*q2*q3*...
                (3*q2^6*(q3-q4)-9*q2^5*q3*q4+3*q3^2*q4*(6*Q2*q3*q4*(q3+2*q4)+...
                Q2^2*(-2*q3^2+q3*q4-8*q4^2)-q3*q4*(q3^2+10*q3*q4-2*q4^2))+q2^4*...
                (-6*Q2^2*(q3-q4)+Q2*(4*q3^2-2*q3*q4-2*q4^2)+q4*(q3^2+16*q3*q4+q4^2))-...
                q2^3*(18*Q2*q3^2*q4+q3*q4*(-23*q3^2+q3*q4-5*q4^2)+Q2^2*...
                (2*q3^2-16*q3*q4+5*q4^2))-2*Q1*(3*q2^5*(q3-q4)-9*q2^4*q3*q4+...
                6*q2^2*q3^2*q4*(2*q3+q4)-3*q3^3*q4*(q3^2-2*q3*q4-8*q4^2)+...
                2*q2^3*q3*(q3^2-2*q3*q4+10*q4^2)+3*q2*q3^2*(q3^3-3*q3^2*q4-8*q3*q4^2-8*q4^3))-...
                3*q2^2*q3*(q3^4+6*q3^3*q4+19*q3^2*q4^2+5*q3*q4^3+2*q4^4+Q2^2*(2*q3^2+13*q4^2)-...
                2*Q2*(2*q3^3+3*q3^2*q4+8*q3*q4^2+2*q4^3))+3*q2*q3*...
                (-2*Q2*q3*q4*(5*q3^2+8*q3*q4+8*q4^2)+q3^2*q4*(2*q3^2+15*q3*q4+13*q4^2)+...
                Q2^2*(2*q3^3+11*q3*q4^2+8*q4^3))+Q1^2*(6*q2^4*(q3-q4)+q2^3*...
                (2*q3^2-16*q3*q4+5*q4^2)+3*q3^2*q4*(2*q3^2-q3*q4+8*q4^2)+q2^2*...
                (6*q3^3+39*q3*q4^2)-3*q2*q3*(2*q3^3+11*q3*q4^2+8*q4^3)))-2*q1^2*...
                (12*q2^6*(q3-q4)-3*q2^5*(3*q3^2+5*q3*q4-5*q4^2)+q2^4*(-2*q3^3-36*Q2^2*(q3-q4)+...
                43*q3^2*q4-2*q3*q4^2+6*q4^3+12*Q2*(2*q3^2-q3*q4-q4^2))-3*q2*q3*...
                (q3^5-5*q3^4*q4-q3^3*q4^2+16*Q2^2*q4^3+q3*q4^2*(3*Q2^2-26*Q2*q4-3*q4^2)-...
                4*q3^2*q4*(Q2^2+Q2*q4+q4^2))-3*q3^2*q4*(-q3^4+2*q3^3*q4-4*Q2^2*q4^2+4*q3^2*q4^2+...
                q3*q4*(Q2^2+6*Q2*q4+q4^2))+Q1^2*(36*q2^4*(q3-q4)+3*q3^2*(q3-4*q4)*q4^2-...
                3*q2^3*(12*q3^2+4*q3*q4-25*q4^2)+3*q2*q3*q4*(-4*q3^2+3*q3*q4+16*q4^2)+...
                q2^2*(8*q3^3+44*q3^2*q4-79*q3*q4^2-36*q4^3))+q2^3*(8*q3^4-24*q3^3*q4-...
                42*q3^2*q4^2+4*q3*q4^3-9*q4^4+3*Q2^2*(12*q3^2+4*q3*q4-25*q4^2)+Q2*...
                (-8*q3^3-32*q3^2*q4+76*q3*q4^2+18*q4^3))-Q1*(12*q2^5*(q3-q4)+...
                15*q3^3*q4^2*(q3+8*q4)+12*q2^3*q3*(q3^2+2*q3*q4-9*q4^2)+q2^4*...
                (-48*q3^2+24*q3*q4+15*q4^2)-12*q2*q3^2*q4*(5*q3^2+9*q3*q4+16*q4^2)+...
                2*q2^2*q3*(20*q3^3-4*q3^2*q4+101*q3*q4^2+36*q4^3))-q2^2*...
                (6*Q2*q3*q4*(-2*q3^2+10*q3*q4+13*q4^2)+Q2^2*...
                (8*q3^3+44*q3^2*q4-79*q3*q4^2-36*q4^3)+q3*(6*q3^4+10*q3^3*q4-...
                32*q3^2*q4^2+10*q3*q4^3-3*q4^4)))+q1*(6*q2^6*q3*(4*q3-7*q4)+...
                6*q2^7*(q3-q4)+q2^5*(-26*q3^3-18*Q2^2*(q3-q4)-17*q3^2*q4+...
                58*q3*q4^2+3*q4^3+6*Q2*(2*q3^2-q3*q4-q4^2))+3*q3^3*q4*...
                (-6*Q2*q3*q4*(q3+2*q4)+q3*q4*(q3^2+10*q3*q4-2*q4^2)+Q2^2*...
                (2*q3^2-q3*q4+8*q4^2))-4*Q1*(9*q2^5*q3*(q3-2*q4)+3*q2^6*(q3-q4)-...
                3*q2^4*q3*(4*q3^2+3*q3*q4-10*q4^2)-3*q3^4*q4*(q3^2-2*q3*q4-8*q4^2)+...
                3*q2*q3^4*(q3^2-6*q3*q4-4*q4^2)+4*q2^3*q3^2*(q3^2+7*q3*q4+q4^2)+...
                3*q2^2*q3^2*(3*q3^3-3*q3^2*q4-4*q3*q4^2-8*q4^3))+2*q2^3*q3*...
                (-6*q3^4-44*q3^3*q4-125*q3^2*q4^2-17*q3*q4^3-15*q4^4+2*Q2^2*...
                (4*q3^2+4*q3*q4-53*q4^2)+6*Q2*(3*q3^3+2*q3^2*q4+20*q3*q4^2+5*q4^3))+...
                q2^4*(2*Q2*q3*(14*q3^2-34*q3*q4-7*q4^2)-3*Q2^2*(16*q3^2-30*q3*q4+5*q4^2)+...
                q3*(2*q3^3+132*q3^2*q4-3*q3*q4^2+22*q4^3))-3*q2*q3^2*(-2*Q2*q3*q4*...
                (5*q3^2+17*q3*q4+38*q4^2)+q3*q4*(3*q3^3+16*q3^2*q4+51*q3*q4^2-10*q4^3)+...
                2*Q2^2*(q3^3+3*q3^2*q4+2*q3*q4^2+24*q4^3))+Q1^2*(18*q2^5*(q3-q4)-4*q2^3*q3*...
                (4*q3^2+4*q3*q4-53*q4^2)+3*q3^3*q4*(-2*q3^2+q3*q4-8*q4^2)+3*q2^4*...
                (16*q3^2-30*q3*q4+5*q4^2)-6*q2^2*q3*(4*q3^3-8*q3^2*q4+35*q3*q4^2+20*q4^3)+...
                6*q2*q3^2*(q3^3+3*q3^2*q4+2*q3*q4^2+24*q4^3))+6*q2^2*q3*...
                (Q2^2*(4*q3^3-8*q3^2*q4+35*q3*q4^2+20*q4^3)-2*Q2*q3*...
                (q3^3+9*q3^2*q4+20*q3*q4^2+21*q4^3)+q3*(q3^4+5*q3^3*q4+40*q3^2*q4^2+...
                22*q3*q4^3+q4^4))))+(3*q1*q2-q1*q3-2*q2*q3)*(k2*(-3*q3*q4+q2*(2*q3+q4))*...
                (3*q2^2*q3*q4+q2^3*(-q3+q4)+3*q3^2*q4*(q3+2*q4)-3*q2*q3*(q3^2+q3*q4+2*q4^2)+...
                q1*(4*q2^2*(q3-q4)+6*q2*q4^2-6*q3*q4^2))+Q2*(q2-q3)*...
                (3*q2^2*q3*(2*q3^2+q4^2)+q2^3*(4*q3^2+q3*q4+4*q4^2)+...
                3*q3^2*q4*(-2*q3^2+q3*q4+10*q4^2)+3*q2*q3*(2*q3^3-...
                5*q3^2*q4-6*q3*q4^2-6*q4^3)-2*q1*(3*q3*q4^2*(q3+5*q4)-...
                3*q2*q4*(4*q3^2+5*q3*q4+3*q4^2)+2*q2^2*(4*q3^2+q3*q4+4*q4^2)))*mx)))/...
                (3*Q2*(16*q1^3*(q2-q4)*(2*q2^3*(q3-q4)-6*q2*q3*q4^2+3*q3^2*q4^2+...
                q2^2*(-2*q3^2+2*q3*q4+3*q4^2))+4*q2*q3*(q2^5*(q3-q4)-...
                3*q2^4*q3*q4+q3^3*q4*(-q3^2+2*q3*q4+8*q4^2)+q2^3*(2*q3^3+7*q3*q4^2)+...
                q2*q3^2*(q3^3-3*q3^2*q4-5*q3*q4^2-8*q4^3))-4*q1*(3*q2^5*q3*(q3-2*q4)+...
                q2^6*(q3-q4)-q2^3*q3^2*q4*(4*q3+5*q4)+q2^4*q3*q4*(q3+11*q4)+q2*q3^4*...
                (q3^2-6*q3*q4-7*q4^2)+q3^4*q4*(-q3^2+2*q3*q4+8*q4^2)+q2^2*q3^2*...
                (3*q3^3+q3^2*q4+7*q3*q4^2-8*q4^3))+q1^2*(8*q2^5*(q3-q4)-...
                4*q2^3*q3*q4*(7*q3+23*q4)+q3^3*q4^2*(13*q3+80*q4)+q2^4*...
                (-20*q3^2+28*q3*q4+13*q4^2)-4*q2*q3^2*q4*(11*q3^2+...
                23*q3*q4+32*q4^2)+2*q2^2*q3*(14*q3^3+10*q3^2*q4+87*q3*q4^2+24*q4^3))));


             r2(cnt1) = (2*k2*Q1*(12*q1^3*(q2-q4)*(2*q2^3*(q3-q4)-6*q2*q3*q4^2+3*q3^2*q4^2+...
                q2^2*(-2*q3^2+2*q3*q4+3*q4^2))+q2*q3*(3*q2^5*(q3-q4)-9*q2^4*q3*q4-...
                6*q2^2*q3^2*q4*(2*q3+q4)-3*q3^3*q4*(q3^2-2*q3*q4-8*q4^2)+...
                2*q2^3*q3*(5*q3^2+2*q3*q4+11*q4^2)+3*q2*q3^2*(q3^3-3*q3^2*q4-...
                2*q3*q4^2-8*q4^3))-q1*(9*q2^5*q3*(q3-2*q4)+3*q2^6*(q3-q4)+...
                3*q2*q3^4*(q3^2-6*q3*q4-10*q4^2)-3*q3^4*q4*(q3^2-2*q3*q4-8*q4^2)+...
                3*q2^4*q3*(4*q3^2+5*q3*q4+12*q4^2)-2*q2^3*q3^2*(2*q3^2+26*q3*q4+17*q4^2)+...
                3*q2^2*q3^2*(3*q3^3+5*q3^2*q4+18*q3*q4^2-8*q4^3))+...
                2*q1^2*(3*q2^5*(q3-q4)+6*q3^3*q4^2*(q3+5*q4)-3*q2^4*(q3^2-5*q3*q4-2*q4^2)-...
                6*q2*q3^2*q4*(3*q3^2+7*q3*q4+8*q4^2)-3*q2^3*q3*(q3^2+9*q3*q4+14*q4^2)+...
                q2^2*q3*(11*q3^3+17*q3^2*q4+80*q3*q4^2+18*q4^3)))+...
                Q2*(k1*(3*q1*q2-q1*q3-2*q2*q3)*(-q2*q3*(3*q2^2+q3*(q3-4*q4))+...
                q1*(3*q2^3-3*q2^2*q3+3*q2*q3^2+q3^2*(q3-4*q4))+6*q1^2*(q2-q3)*(q2-q4))*...
                (-3*q3*q4+q2*(2*q3+q4))+c*Q1*(-6*q1^4*(q2^2-q3^2)*(q2-q4)*...
                (-3*q3*q4+q2*(2*q3+q4))+q1^3*(q2-q3)*(30*q2^4*(2*q3+q4)-3*q3*q4*...
                (q3^3-4*q3^2*q4+24*(Q2-q4)^2*q4)+3*q2^3*(-6*q3^2+32*Q2*...
                (q3-q4)-41*q3*q4+8*q4^2)+24*Q1^2*(q2-q4)*(-3*q3*q4+q2*(2*q3+q4))-...
                12*Q1*(3*q2-q3)*(q2-q4)*(-3*q3*q4+q2*(2*q3+q4))-3*q2^2*...
                (-4*q3^3-3*q3^2*q4+16*Q2*(2*q3-5*q4)*q4+40*q4^3+8*Q2^2*(2*q3+q4))+...
                q2*(2*q3^4-25*q3^3*q4+20*q3^2*q4^2+24*q4^2*(Q2^2-6*Q2*q4+3*q4^2)+...
                24*q3*q4*(5*Q2^2-6*Q2*q4+5*q4^2)))+2*q2*q3*(3*q2^5*(q3^2+2*Q2*(q3-q4)+...
                q3*q4+q4^2)+3*q2^4*(-6*Q2*q3*q4+2*q3*q4*(-q3+q4)+Q2^2*(2*q3+q4))+...
                3*q3^3*(q3-4*q4)*q4*(3*Q2^2+q3^2+2*q4^2-2*Q2*(q3+2*q4))+Q1^2*...
                (-9*q3^3*(q3-4*q4)*q4-3*q2^4*(2*q3+q4)+6*q2^3*q3*(q3+2*q4)+...
                2*q2^2*q3*(q3+2*q4)^2+6*q2*q3^2*(q3^2-4*q3*q4-6*q4^2))-...
                2*Q1*q2*q3*(-9*q2^2*q3*q4-3*q3^2*(q3-4*q4)*q4+3*q2^3*(2*q3+q4)+...
                q2*q3*(2*q3^2-7*q3*q4-4*q4^2))+q2^2*q3*(12*Q2*q3*q4*(2*q3+q4)-...
                2*Q2^2*(q3+2*q4)^2+q3*q4*(-13*q3^2+2*q3*q4+2*q4^2))+q2^3*q3*...
                (-6*Q2^2*(q3+2*q4)+q4*(q3^2-8*q3*q4-20*q4^2)+4*Q2*(q3^2-2*q3*q4+10*q4^2))-...
                3*q2*q3^2*(q3^4-4*q3^3*q4-3*q3^2*q4^2-4*q3*q4^3-8*q4^4+2*Q2^2*...
                (q3^2-4*q3*q4-6*q4^2)-2*Q2*(q3^3-3*q3^2*q4-8*q3*q4^2-8*q4^3)))+...
                q1*(-3*q2^6*(4*q3^2+4*Q2*(q3-q4)+3*q3*q4+2*q4^2)-6*q3^4*(q3-4*q4)*...
                q4*(3*Q2^2+q3^2+2*q4^2-2*Q2*(q3+2*q4))+2*q2^4*q3*...
                (-23*q3^3+9*Q2^2*q4-44*q3^2*q4+10*q3*q4^2+30*q4^3+6*Q2*...
                (4*q3^2+3*q3*q4-10*q4^2))-6*q2^5*(6*Q2*q3*(q3-2*q4)+...
                Q2^2*(2*q3+q4)+q3*(-6*q3^2-5*q3*q4+5*q4^2))+2*Q1^2*...
                (-9*q2^4*q3*q4+9*q3^4*(q3-4*q4)*q4+3*q2^5*(2*q3+q4)-...
                12*q2^3*q3*q4*(2*q3+q4)-3*q2*q3^3*(2*q3^2-15*q3*q4+4*q4^2)+...
                4*q2^2*q3^2*(-4*q3^2+2*q3*q4+11*q4^2))+2*Q1*q2*q3*...
                (-3*q3^3*(q3-4*q4)*q4+15*q2^4*(2*q3+q4)-18*q2^3*q3*(q3+3*q4)+...
                6*q2^2*q3*(3*q3^2+2*q3*q4-2*q4^2)+2*q2*q3^2*(q3^2-17*q3*q4+16*q4^2))+...
                6*q2*q3^3*(-2*Q2*q3*(q3^2-6*q3*q4-4*q4^2)+Q2^2*(2*q3^2-15*q3*q4+4*q4^2)+...
                q3*(q3^3-7*q3^2*q4+5*q3*q4^2-8*q4^3))-2*q2^3*q3*(-12*Q2^2*q4*(2*q3+q4)+...
                8*Q2*q3*(q3^2+7*q3*q4+q4^2)+q3*(q3^3-66*q3^2*q4-24*q3*q4^2+8*q4^3))+...
                q2^2*q3^2*(18*q3^4-17*q3^3*q4-86*q3^2*q4^2+16*q3*q4^3-48*q4^4+8*Q2^2*...
                (4*q3^2-2*q3*q4-11*q4^2)+12*Q2*(-3*q3^3+3*q3^2*q4+4*q3*q4^2+8*q4^3)))+...
                q1^2*(3*q2^6*(2*q3+q4)+6*q2^5*(-15*q3^2+4*Q2*(q3-q4)-8*q3*q4+2*q4^2)+...
                15*q3^3*q4*(Q2^2*(q3-10*q4)+2*Q2*q4*(q3+8*q4)+q4*(-2*q3^2+q3*q4-8*q4^2))+...
                Q1^2*(-15*q3^3*(q3-10*q4)*q4-3*q2^4*(2*q3+q4)+2*q2*q3^2*...
                (5*q3^2-106*q3*q4-79*q4^2)-6*q2^3*(11*q3^2+2*q3*q4-q4^2)+...
                6*q2^2*q3*(13*q3^2+35*q3*q4+3*q4^2))+3*q2^4*(38*q3^3+80*q3^2*q4-...
                2*q3*q4^2-5*q4^3+Q2^2*(2*q3+q4)+Q2*(-32*q3^2+16*q3*q4+10*q4^2))-...
                2*Q1*(3*q3^4*(q3-4*q4)*q4+9*q2^5*(2*q3+q4)-60*q2^2*q3^2*q4*(2*q3+q4)-...
                3*q2^4*q3*(16*q3+17*q4)+12*q2^3*q3*(4*q3^2+10*q3*q4+q4^2)+...
                q2*q3^3*(-2*q3^2+7*q3*q4+76*q4^2))-q2^2*q3*(32*q3^4+3*q3^3*...
                q4-84*q3^2*q4^2+256*q3*q4^3+72*q4^4+6*Q2^2*(13*q3^2+35*q3*q4+3*q4^2)-...
                4*Q2*(20*q3^3-4*q3^2*q4+101*q3*q4^2+36*q4^3))+2*q2^3*(12*Q2*q3*(q3^2+...
                2*q3*q4-9*q4^2)+Q2^2*(33*q3^2+6*q3*q4-3*q4^2)+q3*(q3^3-125*q3^2*q4-...
                32*q3*q4^2+57*q4^3))+2*q2*q3^2*(-12*Q2*q4*(5*q3^2+9*q3*q4+16*q4^2)+Q2^2*...
                (-5*q3^2+106*q3*q4+79*q4^2)+q4*(29*q3^3+2*q3^2*q4+71*q3*q4^2+96*q4^3))))+...
                Q1*(q2-q3)*(mn*(6*q1^3*(5*q2-3*q3)*(q2-q4)*(-3*q3*q4+q2*(2*q3+q4))+...
                q1*q2*(-3*q3^3*(q3-4*q4)*q4+3*q2^3*q3*(-10*q3+q4)-6*q2^4*(2*q3+q4)+...
                3*q2^2*q3*q4*(31*q3+8*q4)+q2*q3^2*(2*q3^2-7*q3*q4-76*q4^2))+2*q2^2*q3*...
                (6*q2^2*q3*(q3-q4)-6*q3^2*(q3-4*q4)*q4+3*q2^3*(2*q3+q4)+q2*q3*...
                (4*q3^2-23*q3*q4-8*q4^2))+q1^2*(-12*q3^3*(q3-4*q4)*q4+3*q2^4*...
                (2*q3+q4)+q2*q3^2*(8*q3^2-37*q3*q4-106*q4^2)-3*q2^3*(12*q3^2+...
                13*q3*q4+2*q4^2)+3*q2^2*q3*(2*q3^2+39*q3*q4+16*q4^2)))+...
                (-2*q2*q3*(9*q2^3*q3*(q3+q4)+3*q2^4*(q3+2*q4)+q2^2*q3*...
                (5*q3^2-13*q3*q4-28*q4^2)-3*q3^2*q4*(q3^2-2*q3*q4-8*q4^2)+...
                3*q2*q3^2*(q3^2-5*q3*q4-2*q4^2))-24*q1^3*(q2-q4)*(3*q3*q4*...
                (q3+q4)+2*q2^2*(q3+2*q4)-q2*(2*q3^2+7*q3*q4+3*q4^2))+2*q1*...
                (3*q2^5*(q3+2*q4)+9*q2^4*q3*(2*q3+3*q4)-3*q3^3*q4*(q3^2-2*q3*q4-8*q4^2)+...
                6*q2^3*q3*(q3^2-6*q3*q4-7*q4^2)+2*q2^2*q3^2*(5*q3^2-4*q3*q4-q4^2)+...
                3*q2*q3^2*(q3^3-6*q3^2*q4-6*q3*q4^2+8*q4^3))+q1^2*(-12*q2^4*(q3+2*q4)+...
                15*q3^2*q4*(q3^2-5*q3*q4-8*q4^2)+3*q2^3*(10*q3^2+31*q3*q4+7*q4^2)-...
                3*q2^2*q3*(16*q3^2+53*q3*q4+51*q4^2)+q2*q3*...
                (-10*q3^3+107*q3^2*q4+263*q3*q4^2+72*q4^3)))*mx)))/...
                (3*Q1*(16*q1^3*(q2-q4)*(2*q2^3*(q3-q4)-6*q2*q3*q4^2+3*q3^2*q4^2+...
                q2^2*(-2*q3^2+2*q3*q4+3*q4^2))+4*q2*q3*(q2^5*(q3-q4)-3*q2^4*q3*q4+...
                q3^3*q4*(-q3^2+2*q3*q4+8*q4^2)+q2^3*(2*q3^3+7*q3*q4^2)+...
                q2*q3^2*(q3^3-3*q3^2*q4-5*q3*q4^2-8*q4^3))-4*q1*(3*q2^5*q3*(q3-2*q4)+...
                q2^6*(q3-q4)-q2^3*q3^2*q4*(4*q3+5*q4)+q2^4*q3*q4*(q3+11*q4)+...
                q2*q3^4*(q3^2-6*q3*q4-7*q4^2)+q3^4*q4*(-q3^2+2*q3*q4+8*q4^2)+...
                q2^2*q3^2*(3*q3^3+q3^2*q4+7*q3*q4^2-8*q4^3))+q1^2*(8*q2^5*(q3-q4)-...
                4*q2^3*q3*q4*(7*q3+23*q4)+q3^3*q4^2*(13*q3+80*q4)+q2^4*...
                (-20*q3^2+28*q3*q4+13*q4^2)-4*q2*q3^2*q4*(11*q3^2+23*q3*q4+32*q4^2)+...
                2*q2^2*q3*(14*q3^3+10*q3^2*q4+87*q3*q4^2+24*q4^3))));
            while q2/Q1*r1(cnt1)+c*(q2-Q1)^2>q2/Q2*r2(cnt1)+c*(q2-Q2)^2 || q3/Q2*r2(cnt1)+c*(q3-Q2)^2>q3/Q1*r1(cnt1)+c*(q3-Q1)^2  % Violation of price constraint
                if q2/Q1*r1(cnt1)+c*(q2-Q1)^2>q2/Q2*r2(cnt1)+c*(q2-Q2)^2
                    eps = 1;

                    r1(cnt1) = -(Q1*(k2*q2*(-q2*q3*(-4*q1*q2+q2^2+3*q3^2)+(-4*q1*q2^2+q2^3+...
                        3*q2^2*q3-3*q2*q3^2+3*q3^3)*q4+6*(q1-q3)*(q2-q3)*q4^2)+...
                        Q2*(c*(q2*q3*(2*q2^2*(2*Q1^2-2*Q1*q2+(q2-2*Q2)*Q2)+...
                        q2*(-6*Q1^2+8*Q1*q2-3*q2^2+6*Q2^2)*q3+6*(Q1^2-2*Q1*q2+(q2-Q2)*Q2)*...
                        q3^2+3*q2*q3^3)+(q2^3*(-Q1^2+4*Q1*q2+Q2*(-2*q2+Q2))-2*q2^2*...
                        (6*Q1^2-8*Q1*q2+q2^2+3*q2*Q2-6*Q2^2)*q3+q2*(15*Q1^2-24*Q1*q2+...
                        5*q2^2+6*q2*Q2-15*Q2^2)*q3^2-6*(Q1^2-2*Q1*q2+(q2-Q2)*Q2)*...
                        q3^3-3*q2*q3^4)*q4-(q2-q3)*(q2^3+3*(-4*Q1^2+8*Q1*q2+(q2-2*Q2)^2)*q3)*...
                        q4^2+6*q2*(q2-q3)*q3*q4^3+2*q1*(2*q2^2*q3*(-Q1^2+(q2-Q2)^2-q2*q3+...
                        Q1*(q2+q3))+q2*(q2*(5*Q1^2-11*Q1*q2+(q2-Q2)*(q2+5*Q2))+(-3*Q1^2+...
                        10*Q1*q2-3*q2^2+3*Q2^2)*q3+(-3*Q1+2*q2)*q3^2)*q4+2*(-3*Q1^2+6*Q1*...
                        q2+q2^2-3*q2*Q2+3*Q2^2)*(q2-q3)*q4^2+3*q2*(-q2+q3)*q4^3)+q1^2*q2*...
                        (q2-q3)*(-3*q3*q4+q2*(2*q3+q4)))+q2*(q2-q3)*(mn*(q1-q2)*...
                        (-3*q3*q4+q2*(2*q3+q4))+(3*q2*q3*(q3+q4)+q2^2*(q3+2*q4)-...
                        3*q3*q4*(q3+2*q4)+q1*(6*q4*(q3+q4)-4*q2*(q3+2*q4)))*mx))))/...
                        (q2*Q2*(2*q2*q3*(q2^2-2*q2*q3+3*q3^2-q1*(q2+q3))+((11*q1-2*q2)*...
                        q2^2-2*q2*(5*q1+4*q2)*q3+3*(q1+4*q2)*q3^2-6*q3^3)*q4+12*(q2-q3)*(-q1+q3)*q4^2))-eps;



                    r2(cnt1) = (k2*Q1*(-q2*q3*(-4*q1*q2+q2^2+3*q3^2)+...
                        (-4*q1*q2^2+q2^3+3*q2^2*q3-3*q2*q3^2+3*q3^3)*q4+6*(q1-q3)*...
                        (q2-q3)*q4^2)+Q2*(c*Q1*(q2*q3*(-2*q2*Q2*(q2+Q2)+2*Q1^2*...
                        (q2-3*q3)+2*q1^2*(q2-q3)+8*Q1*q2*q3-3*(q2^2-2*Q2^2)*q3-...
                        6*Q2*q3^2+3*q3^3+4*q1*(Q1^2+q2^2+2*q2*Q2-Q2^2-q2*q3+Q1*...
                        (-3*q2+q3)))+(q2*(q1^2*q2+q2*(Q1^2+(2*q2-Q2)*Q2)+2*q1*...
                        (Q1^2-3*Q1*q2+q2^2-4*q2*Q2-Q2^2))-2*(2*q1^2*q2+q1*...
                        ((Q1-3*q2)*(3*Q1-q2)-3*Q2^2)+q2*(3*Q1^2-2*Q1*q2+q2^2-3*...
                        q2*Q2-3*Q2^2))*q3+(3*q1^2-6*q1*Q1+9*Q1^2+4*q1*q2-12*Q1*...
                        q2+5*q2^2-6*q2*Q2-9*Q2^2)*q3^2+6*Q2*q3^3-3*q3^4)*...
                        q4-(q2-q3)*(q2^2-4*q1*(q2+3*Q2)+3*(q2+4*Q2)*q3)*q4^2+6*(q1-q3)*...
                        (-q2+q3)*q4^3)+mn*Q1*(q1-q2)*(q2-q3)*(-3*q3*q4+q2*(2*q3+q4))+...
                        (3*q1*q2-(q1+2*q2)*q3)*(-3*q3*q4+q2*(2*q3+q4))*r1(cnt1)+Q1*(q2-q3)*...
                        (3*q2*q3*(q3+q4)+q2^2*(q3+2*q4)-3*q3*q4*(q3+2*q4)+q1*(6*q4*(q3+q4)-...
                        4*q2*(q3+2*q4)))*mx))/(2*Q1*(-q2*q3*(-4*q1*q2+q2^2+3*q3^2)+...
                        (-4*q1*q2^2+q2^3+3*q2^2*q3-3*q2*q3^2+3*q3^3)*q4+6*(q1-q3)*(q2-q3)*q4^2));



                end
                if q3/Q2*r2(cnt1)+c*(q3-Q2)^2>q3/Q1*r1(cnt1)+c*(q3-Q1)^2 % Violation of price constraint
                    eps = 1;
                    r2(cnt1) = -(Q2*(-c*Q1*(-6*q1^3*(q2-q3)*q3*(q2-q4)+q1^2*(q2-q3)*(q3^3+3*q2*...
                        (-4*Q2^2+8*Q2*q3+q3^2)+12*Q1^2*(q2-q4)+12*Q2^2*q4-4*q3*...
                        (6*Q2+q3)*q4+12*Q1*q3*(-q2+q4))+q2*q3*(6*q2^2*Q2*(Q2-2*q3)+...
                        3*q2^3*q3+2*Q1*q3*(3*q2^2+q3*(q3-4*q4))+Q1^2*(-6*q2^2+6*q2*q3+4*q3*...
                        (-q3+q4))-q2*q3*(6*Q2^2+3*q3^2+4*q3*q4+2*q4^2-4*Q2*(2*q3+q4))+...
                        2*q3*(2*Q2^2*(q3-q4)+2*Q2*q3*(-q3+q4)+q3*q4*(2*q3+q4)))+...
                        q1*(-6*q2^3*Q2*(Q2-2*q3)-3*q2^4*q3-2*Q1*q3*(3*q2^3-3*q2^2*q3+...
                        3*q2*q3^2+q3^2*(q3-4*q4))+Q1^2*(6*q2^3-15*q2^2*q3+q3^2*(q3-10*q4)+...
                        6*q2*q3*(2*q3+q4))+q3^2*(2*Q2*q3*(2*q3-11*q4)-Q2^2*(q3-10*q4)+...
                        q3*q4*(2*q3+q4))+q2^2*q3*(15*Q2^2+5*q3^2+4*q3*q4+3*q4^2-6*Q2*(4*q3+q4))-...
                        2*q2*q3*(3*Q2^2*(2*q3+q4)+q3*(q3+q4)*(q3+2*q4)-2*Q2*q3*(4*q3+5*q4))))+...
                        q3*(k1*(-6*q1^2*(q2-q3)*(q2-q4)+q2*q3*(3*q2^2+q3^2-4*q3*q4)-...
                        q1*(3*q2^3-3*q2^2*q3+3*q2*q3^2+q3^3-4*q3^2*q4))+Q1*(q2-q3)*...
                        (mn*(q2*q3*(3*q2+q3-4*q4)+6*q1^2*(-q2+q4)+q1*(-3*q2^2+2*q3*(q3-4*q4)+3*q2*...
                        (q3+2*q4)))+(3*q1*q2-(q1+2*q2)*q3)*(q3-q4)*mx))))/...
                        (Q1*q3*(12*q1^2*(q2-q3)*(q2-q4)+2*q2*q3*(-3*q2^2+q3*...
                        (-q3+q4)+q2*(2*q3+q4))+q1*(6*q2^3+q3^2*(2*q3-11*q4)-...
                        3*q2^2*(4*q3+q4)+2*q2*q3*(4*q3+5*q4))))-eps;


                    r1(cnt1) = (k1*Q2*(-q2*q3*(3*q2^2+q3*(q3-4*q4))+q1*(3*q2^3-3*q2^2*q3+3*q2*q3^2+...
                        q3^2*(q3-4*q4))+6*q1^2*(q2-q3)*(q2-q4))+Q1*(-mn*Q2*(q2-q3)*...
                        (q2*q3*(3*q2+q3-4*q4)+6*q1^2*(-q2+q4)+q1*(-3*q2^2+2*q3*(q3-4*q4)+3*q2*...
                        (q3+2*q4)))+c*Q2*(q1^2*(q2-q3)*(q3*(3*q2+q3-4*q4)+12*Q1*(q2-q4))-...
                        6*q1^3*(q2-q3)*(q2-q4)+q2*q3*(3*q2^3-6*q2*Q2^2+8*q2*Q2*q3+2*Q2^2*...
                        q3-3*q2*q3^2-2*Q1*(3*q2^2+q3*(q3-4*q4))+4*(Q2*(q2+Q2)-...
                        (q2+3*Q2)*q3+q3^2)*q4+2*(-q2+q3)*q4^2+Q1^2*(6*q2-2*(q3+2*q4)))+...
                        q1*(-3*q2^4+2*Q1*(3*q2^3-3*q2^2*q3+3*q2*q3^2+q3^2*(q3-4*q4))-Q1^2*...
                        (3*q2-q3)*(3*q2-q3-2*q4)+q2^2*(9*Q2^2+5*q3^2+4*q3*q4+3*q4^2-6*Q2*(2*q3+q4))+...
                        q3*(-6*Q2*q3*q4+q3*q4*(2*q3+q4)+Q2^2*(q3+2*q4))-2*q2*(3*Q2^2*(q3+q4)+...
                        q3*(q3+q4)*(q3+2*q4)-2*Q2*q3*(q3+5*q4))))+(3*q1*q2-(q1+2*q2)*q3)*...
                        ((-3*q3*q4+q2*(2*q3+q4))*r2(cnt1)-Q2*(q2-q3)*(q3-q4)*mx)))/...
                        (2*Q2*(-q2*q3*(3*q2^2+q3*(q3-4*q4))+q1*(3*q2^3-3*q2^2*q3+...
                        3*q2*q3^2+q3^2*(q3-4*q4))+6*q1^2*(q2-q3)*(q2-q4)));


                end
            end
            p1(cnt1) = 1/(3*((q2+q3)^2-4*q3*q4+4*q1*(-q2+q4)))*...
                (q1-q2)^2*(-((2*(-q3*(q3-4*q4)+3*q1*(q2-q4)-q2*...
                (2*q3+q4))*(c*(q1-Q1)^2*Q1+mn*Q1*(q1-q2)+q1*r1(cnt1)))/...
                (Q1*(q1-q2)^2))+(((q1-q3)*(3*q2+q3-4*q4)*(c*Q1*(Q1-q2)^2+q2*r1(cnt1)))/...
                (Q1*(q1-q2))+(c*Q2*(6*Q2*q3*q4-q3*q4*(2*q3+q4)-Q2^2*(q3+2*q4)+...
                q2*(3*Q2^2+2*q3^2+q4^2-2*Q2*(2*q3+q4)))+(-3*q3*q4+q2*(2*q3+q4))*...
                r2(cnt1)-Q2*(q2-q3)*(q3-q4)*mx)/Q2)/(-q1+q2));

            p2(cnt1) = (mn*Q1*(q1-q2)*Q2*(q2-q3)*(3*q2+q3-4*q4)+c*Q1*Q2*(Q1^2*(q2-3*q3)*...
                (3*q2+q3-4*q4)+q1^2*(q2-q3)*(3*q2+q3-4*q4)+4*Q1*q2*q3*(3*q2+q3-4*q4)+...
                2*q1*(3*q2^3+3*q2*Q2^2+q2^2*q3-4*q2*Q2*q3-Q2^2*q3+2*q2*q3^2+Q1^2*...
                (3*q2+q3-4*q4)-Q1*(3*q2-q3)*(3*q2+q3-4*q4)-2*(2*q2^2+q2*Q2+Q2^2-...
                3*Q2*q3+q3^2)*q4+(q2-q3)*q4^2)+2*q2*(-3*q2^2*q3-6*Q2*q3*q4+q3*q4*...
                (2*q3+q4)+Q2^2*(q3+2*q4)-q2*(3*Q2^2+3*q3^2-4*q3*q4+q4^2-2*Q2*...
                (2*q3+q4))))+9*q1*q2^2*Q2*r1(cnt1)-6*q2^2*Q2*q3*r1(cnt1)-q1*Q2*q3^2*r1(cnt1)-...
                2*q2*Q2*q3^2*r1(cnt1)-12*q1*q2*Q2*q4*r1(cnt1)+4*q1*Q2*q3*q4*r1(cnt1)+8*q2*Q2*q3*...
                q4*r1(cnt1)+4*q1*Q1*q2*q3*r2(cnt1)-4*Q1*q2^2*q3*r2(cnt1)+2*q1*Q1*q2*q4*r2(cnt1)-2*Q1*...
                q2^2*q4*r2(cnt1)-6*q1*Q1*q3*q4*r2(cnt1)+6*Q1*q2*q3*q4*r2(cnt1)-2*Q1*(q1-q2)*...
                Q2*(q2-q3)*(q3-q4)*mx)/(3*Q1*Q2*(-(q2+q3)^2+4*q1*(q2-q4)+4*q3*q4));


            p3(cnt1) = (2*mn*Q1*(q1-q2)*Q2*(q2-q3)*(q3-q4)+c*Q1*Q2*(2*q1^2*(q2-q3)*...
                (q3-q4)+2*q2*(q3*(Q1^2-4*Q2^2+4*Q1*q3+6*Q2*q3-3*q3^2)+...
                (-Q1^2+Q2^2-4*Q1*q3+q3^2)*q4-q3*q4^2)-q2^2*(3*Q2^2+6*q3^2-4*q3*q4+...
                q4^2-2*Q2*(2*q3+q4))+3*q3*(-6*Q2*q3*q4+2*Q1^2*(-q3+q4)+q3*q4*...
                (2*q3+q4)+Q2^2*(q3+2*q4))+4*q1*(q3*(-Q2^2+Q1*(Q1+q3))+q2^2*...
                (q3-q4)-(Q1^2+Q1*q3+2*(Q2^2-3*Q2*q3+q3^2))*q4-q3*q4^2+q2*...
                (3*Q2^2-3*Q1*q3+2*q3^2+3*Q1*q4+q4^2-2*Q2*(2*q3+q4))))+...
                6*q1*q2*Q2*q3*r1(cnt1)-2*q1*Q2*q3^2*r1(cnt1)-4*q2*Q2*q3^2*r1(cnt1)-6*q1*q2*Q2*...
                q4*r1(cnt1)+2*q1*Q2*q3*q4*r1(cnt1)+4*q2*Q2*q3*q4*r1(cnt1)+8*q1*Q1*q2*q3*r2(cnt1)-2*Q1*...
                q2^2*q3*r2(cnt1)-6*Q1*q2*q3^2*r2(cnt1)+4*q1*Q1*q2*q4*r2(cnt1)-Q1*q2^2*q4*r2(cnt1)-12*q1*...
                Q1*q3*q4*r2(cnt1)+9*Q1*q3^2*q4*r2(cnt1)-Q1*Q2*(4*q1-q2-3*q3)*(q2-q3)*...
                (q3-q4)*mx)/(3*Q1*Q2*(-(q2+q3)^2+4*q1*(q2-q4)+4*q3*q4));


            p4(cnt1) = (mn*Q1*(q1-q2)*Q2*(q2-q3)*(q3-q4)+c*Q1*Q2*(q1^2*(q2-q3)*...
                (q3-q4)+q2^2*(-3*Q2^2-3*q3^2+2*q3*q4-2*q4^2+2*Q2*(q3+2*q4))+...
                q2*(Q1^2*(q3-q4)+4*Q1*q3*(q3-q4)+Q2^2*(-7*q3+q4)+6*Q2*q3*(q3+q4)+...
                q3*(-3*q3^2+q3*q4-4*q4^2))+2*q1*(q3*(-Q2^2+Q1*(Q1+q3))+q2^2*(q3-q4)-...
                (Q1^2+5*Q2^2+Q1*q3+2*q3*(-3*Q2+q3))*q4+(6*Q2-q3)*q4^2-3*q4^3+...
                q2*(6*Q2^2-3*Q1*q3+2*q3^2+3*Q1*q4+4*q4^2-4*Q2*(q3+2*q4)))+...
                3*q3*(Q1^2*(-q3+q4)+q4*(3*Q2^2+q3^2+2*q4^2-2*Q2*(q3+2*q4))))+...
                3*q1*q2*Q2*q3*r1(cnt1)-q1*Q2*q3^2*r1(cnt1)-2*q2*Q2*q3^2*r1(cnt1)-3*q1*q2*Q2*q4*r1(cnt1)+...
                q1*Q2*q3*q4*r1(cnt1)+2*q2*Q2*q3*q4*r1(cnt1)+4*q1*Q1*q2*q3*r2(cnt1)-Q1*q2^2*q3*r2(cnt1)-...
                3*Q1*q2*q3^2*r2(cnt1)+8*q1*Q1*q2*q4*r2(cnt1)-2*Q1*q2^2*q4*r2(cnt1)-6*q1*Q1*q3*q4*r2(cnt1)-...
                3*Q1*q2*q3*q4*r2(cnt1)+3*Q1*q3^2*q4*r2(cnt1)-6*q1*Q1*q4^2*r2(cnt1)+6*Q1*q3*q4^2*r2(cnt1)-...
                2*Q1*Q2*(q3-q4)*(-q2*(q2+2*q3)+q1*(4*q2-q3-3*q4)+3*q3*q4)*mx)/...
                (3*Q1*Q2*(-(q2+q3)^2+4*q1*(q2-q4)+4*q3*q4));
            
            d1(cnt1) = (((p2(cnt1)-p1(cnt1))/(q2-q1))-mn)/(mx-mn);
            d2(cnt1) = (((p3(cnt1)-p2(cnt1))/(q3-q2))-((p2(cnt1)-p1(cnt1))/(q2-q1)))/(mx-mn);
            d3(cnt1) = (((p4(cnt1)-p3(cnt1))/(q4-q3)) - ((p3(cnt1)-p2(cnt1))/(q3-q2)))/(mx-mn);
            d4(cnt1) = (mx - ((p4(cnt1)-p3(cnt1))/(q4-q3)))/(mx-mn);
            D1(cnt1) = d1(cnt1)+d2(cnt1);
            D2(cnt1)= d4(cnt1)+d3(cnt1);
            BU1(cnt1) = d1(cnt1)*(p1(cnt1)-(q1/Q1*r1(cnt1)+c*(q1-Q1)^2));
            BU2(cnt1) = d2(cnt1)*(p2(cnt1)-(q2/Q1*r1(cnt1)+c*(q2-Q1)^2));
            BU3(cnt1) = d3(cnt1)*(p3(cnt1)-(q3/Q2*r2(cnt1)+c*(q3-Q2)^2));
            BU4(cnt1) = d4(cnt1)*(p4(cnt1)-(q4/Q2*r2(cnt1)+c*(q4-Q2)^2));
            SU1(cnt1) = (d1(cnt1)*q1/Q1+d2(cnt1)*q2/Q1)*(r1(cnt1)-k1);
            SU2(cnt1) = (d4(cnt1)*q4/Q2+d3(cnt1)*q3/Q2)*(r2(cnt1)-k2);

             
         elseif abs(q2-Q1)>=abs(q2-Q2)&& abs(q3-Q1)>=abs(q3-Q2) % q2 and q3 are closer to Q2
             
             r1(cnt1) = (k2*Q1*(18*q1^3*(q2+q3)*(q2-q4)^3-3*q1^2*(q2-q4)^2*(3*q2^3+q2*q3*(5*q3-26*q4)+...
                q2^2*(19*q3-4*q4)-3*q3^2*(q3+2*q4))+q2^2*(-3*q3^2*q4*...
                (q3^2-5*q3*q4-14*q4^2)+q2^3*(-20*q3^2+q3*q4+q4^2)+q2^2*q3*(16*q3^2+73*q3*q4+q4^2)+...
                q2*q3*(4*q3^3-35*q3^2*q4-89*q3*q4^2-6*q4^3))+3*q1*q2*(9*q2^4*q3+q3^2*q4*... 
                (q3^2-8*q3*q4-20*q4^2)+q2^3*(11*q3^2-33*q3*q4-2*q4^2)+...
                q2^2*(-7*q3^3-43*q3^2*q4+42*q3*q4^2+2*q4^3)-q2*q3*...
                (q3^3-15*q3^2*q4-52*q3*q4^2+18*q4^3)))+Q2*(2*k1*q1*...
                (36*q1^3*(q2-q4)^3-12*q1^2*(q2-q4)^2*(3*q2^2+4*q2*(q3-q4)-q3*(q3+5*q4))+...
                q2*(3*q2^4*(-4*q3+q4)+2*q2^2*q3*(2*q3^2+8*q3*q4-19*q4^2)-3*q3^2*q4*...
                (q3^2-2*q3*q4-8*q4^2)+q2^3*(4*q3^2+34*q3*q4-2*q4^2)+...
                2*q2*q3*(2*q3^3-7*q3^2*q4-19*q3*q4^2+6*q4^3))+3*q1*...
                (3*q2^5+q2^4*(16*q3-13*q4)+2*q2^2*(29*q3-2*q4)*q4^2+q3^2*q4*...
                (q3^2-2*q3*q4-8*q4^2)-2*q2^3*(3*q3^2+25*q3*q4-7*q4^2)-...
                q2*q3*(q3^3-2*q3^2*q4-14*q3*q4^2+24*q4^3)))+Q1*(mn*(q1-q2)*...
                (72*q1^3*(q2-q4)^3-3*q1^2*(q2-q4)^2*(9*q2^2+2*q2*(17*q3-8*q4)-...
                7*q3*(q3+8*q4))+q2*(-12*q3^2*q4*(q3^2-2*q3*q4-8*q4^2)+2*q2^2*q3*...
                (13*q3^2+40*q3*q4+q4^2)+q2^3*(-7*q3^2+2*q3*q4+5*q4^2)+q2*q3*...
                (17*q3^3-70*q3^2*q4-139*q3*q4^2-24*q4^3))+6*q1*(q2^4*(7*q3-q4)+...
                2*q3^2*q4*(q3^2-2*q3*q4-8*q4^2)-q2^3*(4*q3^2+29*q3*q4+3*q4^2)+...
                q2*q3*(-2*q3^3+5*q3^2*q4+33*q3*q4^2-24*q4^3)-q2^2*...
                (q3^3+13*q3^2*q4-46*q3*q4^2-4*q4^3)))+c*(-72*q1^5*(q2-q4)^3+...
                3*q1^4*(q2-q4)^2*(27*q2^2+q2*(38*q3-32*q4)+48*Q1*...
                (q2-q4)-5*q3*(q3+8*q4))-6*q1^3*(q2-q4)*(-q3^4+12*Q1^2*(q2-q4)^2+...
                2*q3^3*q4-12*Q2^2*q4^2+6*Q2*q3*q4^2+4*q3^2*q4^2+q3*q4^3+...
                2*q2^3*(3*Q2+11*q3+q4)-q2^2*(12*Q2^2+4*q3^2-6*Q2*(q3-2*q4)+...
                41*q3*q4+9*q4^2)+Q1*(q2-q4)*(27*q2^2+q2*(38*q3-32*q4)-5*q3*...
                (q3+8*q4))+q2*(q3^3-5*q3^2*q4+q3*q4*(-12*Q2+23*q4)+...
                q4*(24*Q2^2+6*Q2*q4+5*q4^2)))+q1^2*(-9*q2^6+9*q2^5*...
                (2*Q2+7*q4)-q2^4*(81*Q2^2-114*Q2*q3+q3^2+60*Q2*q4-...
                80*q3*q4+142*q4^2)+3*Q1^2*(q2-q4)^2*(27*q2^2+q2*...
                (38*q3-32*q4)-5*q3*(q3+8*q4))+3*q3*q4^2*(-6*Q2*q3*(q3+2*q4)+...
                5*Q2^2*(q3+8*q4)+q3*(q3^2+10*q3*q4-2*q4^2))+q2^3*...
                (-22*q3^3-6*Q2^2*(19*q3-43*q4)-19*q3^2*q4-208*q3*q4^2+...
                123*q4^3+6*Q2*(5*q3^2-64*q3*q4+11*q4^2))-3*q2*q4*...
                (-2*Q2*q3*(6*q3^2+17*q3*q4-26*q4^2)+2*Q2^2*...
                (5*q3^2+59*q3*q4-16*q4^2)+q3*q4*(32*q3^2-3*q3*q4+22*q4^2))+...
                12*Q1*(3*q2^5+3*q2^4*(7*q3-4*q4)+q2^3*q4*(-61*q3+13*q4)+...
                q3^2*q4*(q3^2-2*q3*q4-8*q4^2)+q2*q3*(-q3^3+q3^2*q4+21*q3*q4^2-24*q4^3)+...
                q2^2*(q3^3-13*q3^2*q4+64*q3*q4^2-4*q4^3))+q2^2*...
                (-4*q3^4+92*q3^3*q4+11*q3^2*q4^2+198*q3*q4^3-36*q4^4+3*Q2^2*...
                (5*q3^2+116*q3*q4-91*q4^2)-6*Q2*(3*q3^3+16*q3^2*q4-71*q3*q4^2+4*q4^3)))+...
                q2*(-9*q2^5*q3*(q3-q4)-6*Q2^2*q3^2*q4*(q3^2-2*q3*q4-8*q4^2)+...
                q2^4*(3*q3^3+55*q3^2*q4-23*q3*q4^2+q4^3+6*Q2^2*...
                (-4*q3+q4)+Q2*(40*q3^2-2*q3*q4-2*q4^2))+Q1^2*(6*q2^4*(4*q3-q4)+...
                6*q3^2*q4*(q3^2-2*q3*q4-8*q4^2)+q2^3*(17*q3^2-58*q3*q4+5*q4^2)+...
                2*q2^2*q3*(q3^2-50*q3*q4+31*q4^2)+q2*q3*(-7*q3^3+14*q3^2*q4+...
                125*q3*q4^2-24*q4^3))+q2^2*q3*(-3*q3^4+q3^3*q4-47*q3^2*q4^2+...
                91*q3*q4^3-6*q4^4-2*Q2^2*(q3^2-50*q3*q4+31*q4^2)+Q2*...
                (-8*q3^3+70*q3^2*q4+178*q3*q4^2+12*q4^3))-q2^3*...
                (2*Q2*q3*(16*q3^2+73*q3*q4+q4^2)+Q2^2*(17*q3^2-58*q3*q4+5*q4^2)-...
                q3*(9*q3^3+4*q3^2*q4-101*q3*q4^2+16*q4^3))+q2*q3*(6*Q2*q3*q4*...
                (q3^2-5*q3*q4-14*q4^2)+3*q3*q4*(q3^3-3*q3^2*q4+12*q3*q4^2-10*q4^3)+...
                Q2^2*(7*q3^3-14*q3^2*q4-125*q3*q4^2+24*q4^3)))+q1*...
                (-2*Q1*q2*(6*q2^4*(4*q3-q4)+6*q3^2*q4*(q3^2-2*q3*q4-8*q4^2)+...
                q2^3*(17*q3^2-58*q3*q4+5*q4^2)+2*q2^2*q3*(q3^2-50*q3*q4+31*q4^2)+...
                q2*q3*(-7*q3^3+14*q3^2*q4+125*q3*q4^2-24*q4^3))-6*Q1^2*...
                (3*q2^5+3*q2^4*(7*q3-4*q4)+q2^3*q4*(-61*q3+13*q4)+q3^2*q4*...
                (q3^2-2*q3*q4-8*q4^2)+q2*q3*(-q3^3+q3^2*q4+21*q3*q4^2-24*q4^3)+...
                q2^2*(q3^3-13*q3^2*q4+64*q3*q4^2-4*q4^3))+(q2-q4)*(9*q2^5*(2*q3-q4)-...
                6*Q2^2*q3^2*(q3^2-2*q3*q4-8*q4^2)+q2^4*...
                (18*Q2^2-54*Q2*q3+q3^2-101*q3*q4+10*q4^2)+q2^3*(25*q3^3+18*Q2^2*...
                (7*q3-3*q4)-71*q3^2*q4+160*q3*q4^2-6*q4^3+Q2*...
                (-66*q3^2+144*q3*q4+12*q4^2))+3*q2*q3*(2*Q2*q3*(q3^2-8*q3*q4-20*q4^2)+...
                2*Q2^2*(q3^2-13*q3*q4+24*q4^2)+q3*(q3^3-2*q3^2*q4+22*q3*q4^2-12*q4^3))+...
                q2^2*(24*Q2^2*q4*(-10*q3+q4)+6*Q2*q3*(7*q3^2+32*q3*q4-18*q4^2)-...
                q3*(11*q3^3+65*q3^2*q4-88*q3*q4^2+66*q4^3)))))+(-6*q1^3*(q2-q4)^2*...
                (q2*(5*q3+q4)+q3*(q3+5*q4))+q2^2*(q2^2*q3*(10*q3^2+7*q3*q4+q4^2)+q2^3*...
                (13*q3^2+q3*q4+4*q4^2)+9*q3^2*q4*(-q3^2+q3*q4+6*q4^2)+q2*q3*...
                (13*q3^3-35*q3^2*q4-50*q3*q4^2-18*q4^3))-q1*q2*(9*q2^4*q3+q2^3*...
                (67*q3^2+19*q3*q4+22*q4^2)+3*q3^2*q4*(-5*q3^2+4*q3*q4+28*q4^2)+q2^2*...
                (13*q3^3-71*q3^2*q4-86*q3*q4^2-18*q4^3)+q2*q3*...
                (19*q3^3-41*q3^2*q4-56*q3*q4^2+42*q4^3))+3*q1^2*(q2^4*(13*q3+2*q4)+...
                2*q2^3*(10*q3^2-2*q3*q4+q4^2)+q3^2*q4*(-2*q3^2+q3*q4+10*q4^2)+...
                q2^2*(q3^3-30*q3^2*q4-39*q3*q4^2-4*q4^3)+2*q2*(q3^4-q3^3*q4+15*q3*q4^3)))*mx)))/...
                (3*q1*Q2*(48*q1^3*(q2-q4)^3-q1^2*(q2-q4)^2*...
                (51*q2^2+70*q2*q3-13*q3^2-64*q2*q4-80*q3*q4)+2*q1*(6*q2^5+q2^4*(37*q3-25*q4)-...
                3*q2^3*(2*q3^2+37*q3*q4-9*q4^2)+2*q3^2*q4*(q3^2-2*q3*q4-8*q4^2)+q2*q3*...
                (-2*q3^3+3*q3^2*q4+35*q3*q4^2-48*q4^3)+q2^2*(q3^3-13*q3^2*q4+122*q3*q4^2-8*q4^3))+...
                q2*(4*q2^4*(-4*q3+q4)+2*q2^2*q3*(q3^2+22*q3*q4-23*q4^2)-...
                4*q3^2*q4*(q3^2-2*q3*q4-8*q4^2)-3*q2^3*(q3^2-14*q3*q4+q4^2)+...
                q2*q3*(5*q3^3-14*q3^2*q4-67*q3*q4^2+16*q4^3))));


             r2(cnt1) = (2*k2*Q1*(36*q1^3*(q2-q4)^3-12*q1^2*(q2-q4)^2*...
                (3*q2^2+4*q2*(q3-q4)-q3*(q3+5*q4))+q2*(3*q2^4*(-4*q3+q4)+...
                2*q2^2*q3*(2*q3^2+8*q3*q4-19*q4^2)-3*q3^2*q4*(q3^2-2*q3*q4-8*q4^2)+...
                q2^3*(4*q3^2+34*q3*q4-2*q4^2)+2*q2*q3*(2*q3^3-7*q3^2*q4-19*q3*q4^2+6*q4^3))+...
                3*q1*(3*q2^5+q2^4*(16*q3-13*q4)+2*q2^2*(29*q3-2*q4)*q4^2+q3^2*q4*...
                (q3^2-2*q3*q4-8*q4^2)-2*q2^3*(3*q3^2+25*q3*q4-7*q4^2)-q2*q3*...
                (q3^3-2*q3^2*q4-14*q3*q4^2+24*q4^3)))+Q2*(k1*q1*(18*q1^2*(q2+q3)*...
                (q2-q4)^2-3*q1*(3*q2^4+5*q2^2*q3*(q3-7*q4)+3*q2^3*(5*q3-q4)-q3^2*...
                (q3-4*q4)*q4+q2*q3*(q3^2-9*q3*q4+20*q4^2))+q2*(3*q2^3*(5*q3+q4)+...
                q2^2*(13*q3^2-29*q3*q4-2*q4^2)+q2*q3*(7*q3^2-35*q3*q4+10*q4^2)+...
                q3^2*(q3^2-11*q3*q4+28*q4^2)))+Q1*(2*mn*(q1-q2)*(27*q1^2*(q2+q3)*...
                (q2-q4)^2+q2*(3*q2^3*(5*q3+q4)+q2*q3*(14*q3^2-67*q3*q4-q4^2)+q2^2*...
                (23*q3^2-22*q3*q4-q4^2)+2*q3^2*(q3^2-11*q3*q4+28*q4^2))-...
                3*q1*(3*q2^4+q2^3*(22*q3-q4)-2*q3^2*(q3-4*q4)*q4+q2^2*...
                (9*q3^2-52*q3*q4-2*q4^2)+q2*q3*(2*q3^2-17*q3*q4+30*q4^2)))+...
                c*(18*q1^4*(q2+q3)*(q2-q4)^2-3*q1^3*(q2-q4)*(27*q2^3+q3^3+12*Q1*...
                (q2+q3)*(q2-q4)-4*q3^2*q4-48*Q2*q4^2+24*q4^3-3*q2^2*(16*Q2-5*q3+8*q4)+...
                q2*(5*q3^2+96*Q2*q4-20*q3*q4-24*q4^2))+q1^2*(81*q2^5+18*Q1^2*...
                (q2+q3)*(q2-q4)^2-3*q2^4*(54*Q2-37*q3+46*q4)-q2^3*...
                (18*Q2^2+228*Q2*q3-46*q3^2-516*Q2*q4+257*q3*q4+59*q4^2)+...
                q2^2*(-23*q3^3-18*Q2^2*(q3-2*q4)-86*q3^2*q4+58*q3*q4^2+...
                213*q4^3+6*Q2*(5*q3^2+116*q3*q4-91*q4^2))-3*q3*q4^2*...
                (6*Q2^2-10*Q2*(q3+8*q4)+5*(2*q3^2-q3*q4+8*q4^2))+q2*...
                (q3^4+49*q3^3*q4+q3^2*q4*(-60*Q2+31*q4)-6*q4^2*(3*Q2^2-32*Q2*q4+16*q4^2)+...
                12*q3*q4*(3*Q2^2-59*Q2*q4+17*q4^2))+6*Q1*(3*q2^4+5*q2^2*q3*(q3-7*q4)+...
                3*q2^3*(5*q3-q4)-q3^2*(q3-4*q4)*q4+q2*q3*(q3^2-9*q3*q4+20*q4^2)))+...
                q2*(18*q2^5*q3-3*q2^4*(16*Q2*q3-9*q3^2-4*Q2*q4+7*q3*q4+2*q4^2)+...
                q3^2*(q3-4*q4)*(-Q2^2*(q3-7*q4)-12*Q2*q4*(q3+2*q4)+6*q4*(q3^2+2*q4^2))-...
                q2^3*(-6*q3^3+76*q3^2*q4+25*q3*q4^2-5*q4^3+3*Q2^2*(5*q3+q4)+2*Q2*...
                (17*q3^2-58*q3*q4+5*q4^2))+Q1^2*(3*q2^3*(5*q3+q4)+q2^2*...
                (13*q3^2-29*q3*q4-2*q4^2)+q2*q3*(7*q3^2-35*q3*q4+10*q4^2)+...
                q3^2*(q3^2-11*q3*q4+28*q4^2))-q2*q3*(6*q3^4-32*q3^3*q4+q3^2*q4^2-...
                71*q3*q4^3+24*q4^4+Q2^2*(7*q3^2-35*q3*q4+10*q4^2)+Q2*...
                (-14*q3^3+28*q3^2*q4+250*q3*q4^2-48*q4^3))+q2^2*(Q2^2*...
                (-13*q3^2+29*q3*q4+2*q4^2)-4*Q2*q3*(q3^2-50*q3*q4+31*q4^2)+...
                q3*(-9*q3^3-13*q3^2*q4+20*q3*q4^2+56*q4^3)))+q1*...
                (-3*Q1^2*(3*q2^4+5*q2^2*q3*(q3-7*q4)+3*q2^3*...
                (5*q3-q4)-q3^2*(q3-4*q4)*q4+q2*q3*(q3^2-9*q3*q4+20*q4^2))-...
                2*Q1*q2*(3*q2^3*(5*q3+q4)+q2^2*(13*q3^2-29*q3*q4-2*q4^2)+...
                q2*q3*(7*q3^2-35*q3*q4+10*q4^2)+q3^2*(q3^2-11*q3*q4+28*q4^2))-...
                (q2-q4)*(18*q2^5-3*q2^4*(12*Q2-34*q3+q4)-q2^3*(9*Q2^2-58*q3^2+...
                36*Q2*(7*q3-3*q4)+107*q3*q4+50*q4^2)-q2^2*(45*Q2^2*q3+20*q3^3+...
                77*q3^2*q4+116*q3*q4^2-24*q4^3+48*Q2*q4*(-10*q3+q4))-3*q3^2*(q3-4*q4)*...
                (Q2^2-4*Q2*(q3+2*q4)+2*(q3^2+2*q4^2))+q2*q3*(-8*q3^3-15*Q2^2*...
                (q3-4*q4)+19*q3^2*q4-38*q3*q4^2+144*q4^3-12*Q2*(q3^2-13*q3*q4+24*q4^2)))))+...
                (-72*q1^3*(q2-q4)^2*(q3+q4)+q2*(6*q2^4*(q3+2*q4)+2*q2^2*q3*...
                (13*q3^2-17*q3*q4-32*q4^2)-6*q3^2*q4*(q3^2-2*q3*q4-8*q4^2)+...
                q2^3*(29*q3^2+14*q3*q4-7*q4^2)+q2*q3*(11*q3^3-58*q3^2*q4-13*q3*q4^2+24*q4^3))+...
                3*q1^2*(q2^3*(39*q3+45*q4)+q2^2*(28*q3^2-59*q3*q4-77*q4^2)-...
                5*q3*q4*(q3^2-5*q3*q4-8*q4^2)+q2*(5*q3^3-53*q3^2*q4-20*q3*q4^2+32*q4^3))-...
                q1*(q2^4*(51*q3+75*q4)+q2^3*(113*q3^2-19*q3*q4-94*q4^2)-6*q3^2*q4*...
                (q3^2-2*q3*q4-8*q4^2)+q2^2*(41*q3^3-193*q3^2*q4-196*q3*q4^2+24*q4^3)+...
                q2*q3*(11*q3^3-73*q3^2*q4+62*q3*q4^2+144*q4^3)))*mx)))/...
                (3*Q1*(48*q1^3*(q2-q4)^3-q1^2*(q2-q4)^2*(51*q2^2+70*q2*q3-13*...
                q3^2-64*q2*q4-80*q3*q4)+2*q1*(6*q2^5+q2^4*(37*q3-25*q4)-3*q2^3*...
                (2*q3^2+37*q3*q4-9*q4^2)+2*q3^2*q4*(q3^2-2*q3*q4-8*q4^2)+...
                q2*q3*(-2*q3^3+3*q3^2*q4+35*q3*q4^2-48*q4^3)+q2^2*...
                (q3^3-13*q3^2*q4+122*q3*q4^2-8*q4^3))+q2*(4*q2^4*...
                (-4*q3+q4)+2*q2^2*q3*(q3^2+22*q3*q4-23*q4^2)-4*q3^2*q4*...
                (q3^2-2*q3*q4-8*q4^2)-3*q2^3*(q3^2-14*q3*q4+q4^2)+...
                q2*q3*(5*q3^3-14*q3^2*q4-67*q3*q4^2+16*q4^3))));
            while q2/Q2*r2(cnt1)+c*(q2-Q2)^2>q2/Q1*r1(cnt1)+c*(q2-Q1) || q1/Q1*r1(cnt1)+c*(q1-Q1)^2>q1/Q2*r2(cnt1)+c*(q1-Q2)^2 % Violation of price constraint
                if q2/Q2*r2(cnt1)+c*(q2-Q2)^2>q2/Q1*r1(cnt1)+c*(q2-Q1)
                    eps = 1;
                    r2(cnt1) =-(Q2*(c*Q1*(6*q1^3*q2*(-q2+q4)+q1^2*(q2*(3*((-2*Q1+q2)^2+...
                        8*q2*Q2-4*Q2^2)+2*q2*q3+q3^2)-2*(6*Q1^2-6*Q1*q2+q2^2-6*Q2^2+...
                        2*q2*(6*Q2+q3))*q4)+q1*(3*q2^4+2*Q2^2*q3*(q3-4*q4)+...
                        q2^3*(-18*Q2+q3-4*q4)-2*Q1^2*(6*q2^2+2*q2*q3+q3^2-5*q2*q4-4*q3*q4)+...
                        2*Q1*q2*(3*q2^2+2*q2*q3+q3^2-2*(q2+2*q3)*q4)+q2^2*...
                        (2*(6*Q2^2-7*Q2*q3+q3^2)+14*Q2*q4+q4^2)+q2*(4*Q2*(Q2-q3)*q3-2*...
                        (5*Q2^2-11*Q2*q3+q3^2)*q4-q3*q4^2))+q2*(-3*q2^3*q3-Q2^2*q3*(q3-4*q4)+...
                        Q1^2*(3*q2^2+2*q2*q3+q3^2-2*(q2+2*q3)*q4)+q2*(2*Q2*q3*...
                        (q3-7*q4)+2*Q2^2*(-q3+q4)+q3*q4*(2*q3+q4))-q2^2*(3*Q2^2+3*q3^2-...
                        4*q3*q4+q4^2-2*Q2*(5*q3+q4))))+q2*(k1*q1*(6*q1*q2-3*q2^2-2*q2*q3-...
                        q3^2+2*(-3*q1+q2+2*q3)*q4)+Q1*(q1-q2)*(-2*mn*(-3*q1*q2+2*q2*q3+q3^2+...
                        (3*q1+q2-4*q3)*q4)-(q2-q3)*(q3-q4)*mx))))/...
                        (Q1*q2*(q1*(9*q2^2+q3*(2*q3-11*q4)+7*q2*(q3-q4))+...
                        12*q1^2*(-q2+q4)-q2*(q3*(q3-7*q4)+q2*(5*q3+q4))))-eps;


                    r1(cnt1) = (k1*q1*Q2*(6*q1*q2-3*q2^2-2*q2*q3-q3^2+2*(-3*q1+q2+2*q3)*q4)+...
                        Q1*(2*mn*(q1-q2)*Q2*(-q3*(q3-4*q4)+3*q1*(q2-q4)-q2*(2*q3+q4))+...
                        c*Q2*(-3*q2^2*Q2^2-3*q2^3*q3+10*q2^2*Q2*q3-2*q2*Q2^2*q3-3*q2^2*q3^2+...
                        2*q2*Q2*q3^2-Q2^2*q3^2+2*(2*Q2^2*q3+q2^2*(Q2+2*q3)+...
                        q2*(Q2^2-7*Q2*q3+q3^2))*q4+q2*(-q2+q3)*q4^2+6*q1^3*(-q2+q4)+Q1^2*...
                        (3*q2^2+2*q2*q3+q3^2-2*(q2+2*q3)*q4)+q1^2*(12*Q1*q2+3*q2^2+2*q2*q3+...
                        q3^2-2*(6*Q1+q2+2*q3)*q4)+q1*(6*Q1^2*(-q2+q4)-2*Q1*(3*q2^2+2*q2*q3+q3^2-...
                        2*(q2+2*q3)*q4)+(q2-q4)*(3*q2^2+6*Q2^2-6*Q2*q3+q2*(-6*Q2+q3-q4)+...
                        q3*(2*q3+q4))))+(3*q1*(q2+q3)*(q2-q4)-q2*(q3*(q3-7*q4)+q2*(5*q3+q4)))*...
                        r2(cnt1)-(q1-q2)*Q2*(q2-q3)*(q3-q4)*mx))/...
                        (2*q1*Q2*(6*q1*q2-3*q2^2-2*q2*q3-q3^2+2*(-3*q1+q2+2*q3)*q4));


                end

                if q1/Q1*r1(cnt1)+c*(q1-Q1)^2>q1/Q2*r2(cnt1)+c*(q1-Q2)^2
                    eps = 1;
                    r1(cnt1) = -(Q1*(k2*q1*(-6*q1^2*(q2-q4)^2+3*q1*(q2-q4)*(q2^2+2*q2*(q3-q4)-...
                        q3*(q3+2*q4))+q2*(q2^2*(-4*q3+q4)+4*q2*q3*(q3+2*q4)-3*q3*q4*(q3+2*q4)))+...
                        Q2*(-mn*q1*(q1-q2)*(3*q1*(q2+q3)*(q2-q4)-q2*(q3*(q3-7*q4)+q2*(5*q3+q4)))-...
                        c*(3*q1^4*(q2+q3)*(q2-q4)-2*q2*(Q1^2-Q2^2)*(q2^2*(4*q3-q4)-...
                        4*q2*q3*(q3+2*q4)+3*q3*q4*(q3+2*q4))+q1^3*(-6*q2^3+6*Q1*...
                        (3*q2-q3-4*q4)*(q2-q4)-6*q4^2*(2*Q2+q4)+q2^2*(-12*Q2-5*q3+5*q4)+...
                        q2*(-q3^2+7*q3*q4+6*q4*(4*Q2+q4)))+q1*(-3*q2^4*q3-6*Q2^2*q3*q4*...
                        (q3+2*q4)+q2^3*(-6*Q2^2-8*Q2*q3+2*Q2*q4+2*q3*q4+q4^2)+4*Q1*q2*...
                        (q2^2*(4*q3-q4)-4*q2*q3*(q3+2*q4)+3*q3*q4*(q3+2*q4))+q2*...
                        (-6*Q2*q3*q4*(q3+2*q4)+Q2^2*(7*q3^2+17*q3*q4-12*q4^2)-...
                        3*q3*q4*(q3^2+2*q4^2))+q2^2*(8*Q2*q3*(q3+2*q4)+Q2^2*...
                        (-7*q3+19*q4)+q3*(3*q3^2+q3*q4+5*q4^2))+Q1^2*(6*q2^3+...
                        q2^2*(7*q3-19*q4)+6*q3*q4*(q3+2*q4)+q2*(-7*q3^2-17*q3*q4+12*q4^2)))+...
                        q1^2*(-3*Q1^2*(3*q2-q3-4*q4)*(q2-q4)-2*Q1*(6*q2^3+q2^2*(7*q3-19*q4)+...
                        6*q3*q4*(q3+2*q4)+q2*(-7*q3^2-17*q3*q4+12*q4^2))+(q2-q4)*...
                        (3*q2^3+q2^2*(6*Q2+5*q3+q4)+q2*(9*Q2^2+q3^2+12*Q2*(q3-q4)-...
                        q3*q4-6*q4^2)-3*(q3^3+2*q3*q4^2+2*Q2*q3*(q3+2*q4)+Q2^2*(q3+4*q4)))))+...
                        q1*(6*q1^2*(q2-q4)*(q3+q4)+q2*(q2*q3*(5*q3+q4)+q2^2*...
                        (q3+2*q4)-3*q3*q4*(q3+2*q4))+q1*(3*q3*q4*(q3+2*q4)-q2^2*...
                        (7*q3+8*q4)+q2*(-5*q3^2+5*q3*q4+6*q4^2)))*mx)))/...
                        (q1*Q2*(3*q1^2*(3*q2-q3-4*q4)*(q2-q4)+2*q2*(q2^2*(4*q3-q4)-...
                        4*q2*q3*(q3+2*q4)+3*q3*q4*(q3+2*q4))-q1*(6*q2^3+q2^2*...
                        (7*q3-19*q4)+6*q3*q4*(q3+2*q4)+q2*(-7*q3^2-17*q3*q4+12*q4^2))))-eps;

                    r2(cnt1) = (k2*Q1*(6*q1^2*(q2-q4)^2-3*q1*(q2-q4)*(q2^2+2*q2*(q3-q4)-...
                        q3*(q3+2*q4))+q2*(q2^2*(4*q3-q4)-4*q2*q3*(q3+2*q4)+...
                        3*q3*q4*(q3+2*q4)))-Q2*(-mn*Q1*(q1-q2)*(3*q1*(q2+q3)*...
                        (q2-q4)-q2*(q3*(q3-7*q4)+q2*(5*q3+q4)))-c*Q1*(3*q1^3*(q2+q3)*...
                        (q2-q4)+q1^2*(-6*q2^3-6*Q1*(q2+q3)*(q2-q4)+6*(2*Q2-q4)*q4^2+...
                        q2^2*(12*Q2-5*q3+5*q4)-q2*(q3^2+24*Q2*q4-7*q3*q4-6*q4^2))+q2*...
                        (-3*q2^3*q3+q2^2*(8*Q2*q3-2*Q2*q4+2*q3*q4+q4^2)-Q1^2*(q3*(q3-7*q4)+...
                        q2*(5*q3+q4))+q3*(Q2^2*(q3-7*q4)+6*Q2*q4*(q3+2*q4)-3*q4*(q3^2+2*q4^2))+...
                        q2*(Q2^2*(5*q3+q4)-8*Q2*q3*(q3+2*q4)+q3*(3*q3^2+q3*q4+5*q4^2)))+...
                        q1*(3*Q1^2*(q2+q3)*(q2-q4)+2*Q1*q2*(q3*(q3-7*q4)+q2*(5*q3+q4))+...
                        (q2-q4)*(3*q2^3+q2^2*(-6*Q2+5*q3+q4)+q2*(-3*Q2^2+q3^2-12*Q2*(q3-q4)-...
                        q3*q4-6*q4^2)-3*q3*(Q2^2+q3^2+2*q4^2-2*Q2*(q3+2*q4)))))-...
                        3*q1^2*q2^2*r1(cnt1)-3*q1^2*q2*q3*r1(cnt1)+5*q1*q2^2*q3*r1(cnt1)+q1*q2*q3^2*r1(cnt1)+...
                        3*q1^2*q2*q4*r1(cnt1)+q1*q2^2*q4*r1(cnt1)+3*q1^2*q3*q4*r1(cnt1)-7*q1*q2*q3*q4*r1(cnt1)+...
                        6*q1^2*Q1*q2*q3*mx-7*q1*Q1*q2^2*q3*mx+Q1*q2^3*q3*mx-5*q1*Q1*q2*q3^2*mx+...
                        5*Q1*q2^2*q3^2*mx+6*q1^2*Q1*q2*q4*mx-8*q1*Q1*q2^2*q4*mx+2*Q1*q2^3*q4*mx-...
                        6*q1^2*Q1*q3*q4*mx+5*q1*Q1*q2*q3*q4*mx+Q1*q2^2*q3*q4*mx+3*q1*Q1*q3^2*q4*mx-...
                        3*Q1*q2*q3^2*q4*mx-6*q1^2*Q1*q4^2*mx+6*q1*Q1*q2*q4^2*mx+6*q1*Q1*q3*q4^2*mx-...
                        6*Q1*q2*q3*q4^2*mx))/(2*Q1*(6*q1^2*(q2-q4)^2-3*q1*(q2-q4)*...
                        (q2^2+2*q2*(q3-q4)-q3*(q3+2*q4))+q2*(q2^2*(4*q3-q4)-...
                        4*q2*q3*(q3+2*q4)+3*q3*q4*(q3+2*q4))));




                end
            end
            
            p1(cnt1) = -(-2*mn*Q1*(q1-q2)*Q2*(-q3*(q3-4*q4)+3*q1*(q2-q4)-q2*(2*q3+q4))+...
                c*Q1*Q2*(3*q2^3*q3+(2*Q1^2+Q2^2)*q3*(q3-4*q4)+6*q1^3*(-q2+q4)+...
                2*q1^2*(6*Q1*q2+2*q2*q3+q3^2+(-6*Q1+q2-4*q3)*q4)+...
                q2*(-2*Q2*q3*(q3-7*q4)+2*Q2^2*(q3-q4)+2*Q1^2*(2*q3+q4)-...
                q3*q4*(2*q3+q4))+q2^2*(3*Q2^2+3*q3^2-4*q3*q4+q4^2-2*Q2*...
                (5*q3+q4))+q1*(6*Q1^2*(-q2+q4)-4*Q1*(q3*(q3-4*q4)+...
                q2*(2*q3+q4))-(q2-q4)*(3*q2^2+6*Q2^2-6*Q2*q3+q2*(-6*Q2+q3-q4)+...
                q3*(2*q3+q4))))-6*q1^2*q2*Q2*r1(cnt1)+4*q1*q2*Q2*q3*r1(cnt1)+...
                2*q1*Q2*q3^2*r1(cnt1)+6*q1^2*Q2*q4*r1(cnt1)+2*q1*q2*Q2*q4*r1(cnt1)-8*q1*Q2*q3*q4*r1(cnt1)-...
                3*q1*Q1*q2^2*r2(cnt1)-3*q1*Q1*q2*q3*r2(cnt1)+5*Q1*q2^2*q3*r2(cnt1)+Q1*q2*q3^2*r2(cnt1)+...
                3*q1*Q1*q2*q4*r2(cnt1)+Q1*q2^2*q4*r2(cnt1)+3*q1*Q1*q3*q4*r2(cnt1)-7*Q1*q2*q3*q4*r2(cnt1)+...
                Q1*(q1-q2)*Q2*(q2-q3)*(q3-q4)*mx)/...
                (3*Q1*Q2*(-(q2+q3)^2+4*q1*(q2-q4)+4*q3*q4));


            p2(cnt1) = (mn*Q1*(q1-q2)*Q2*(q2-q3)*(3*q2+q3-4*q4)+c*Q1*Q2*(-6*q2^2*Q2^2-...
                2*q2*(3*q2^2-10*q2*Q2+2*Q2^2)*q3-2*(3*q2^2-2*q2*Q2+Q2^2)*q3^2+...
                q1^2*(q2-q3)*(3*q2+q3-4*q4)+Q1^2*(q2-q3)*(3*q2+q3-4*q4)+...
                4*(2*Q2^2*q3+q2^2*(Q2+2*q3)+q2*(Q2^2-7*Q2*q3+q3^2))*q4+...
                2*q2*(-q2+q3)*q4^2-2*q1*(Q1*(q2-q3)*(3*q2+q3-4*q4)-...
                (q2-q4)*(3*q2^2+6*Q2^2-6*Q2*q3+q2*(-6*Q2+q3-q4)+q3*(2*q3+q4))))+...
                3*q1*q2^2*Q2*r1(cnt1)-2*q1*q2*Q2*q3*r1(cnt1)-q1*Q2*q3^2*r1(cnt1)-4*q1*q2*Q2*q4*r1(cnt1)+...
                4*q1*Q2*q3*q4*r1(cnt1)+6*q1*Q1*q2^2*r2(cnt1)+6*q1*Q1*q2*q3*r2(cnt1)-...
                10*Q1*q2^2*q3*r2(cnt1)-2*Q1*q2*q3^2*r2(cnt1)-6*q1*Q1*q2*q4*r2(cnt1)-2*Q1*q2^2*q4*r2(cnt1)-...
                6*q1*Q1*q3*q4*r2(cnt1)+14*Q1*q2*q3*q4*r2(cnt1)-2*Q1*(q1-q2)*Q2*(q2-q3)*(q3-q4)*mx)/...
                (3*Q1*Q2*(-(q2+q3)^2+4*q1*(q2-q4)+4*q3*q4));

            p3(cnt1) = (2*mn*Q1*(q1-q2)*Q2*(q2-q3)*(q3-q4)+c*Q1*Q2*(2*q1^2*(q2-q3)*(q3-q4)-...
                q2^2*(3*Q2^2+6*q3^2-4*q3*q4+q4^2-2*Q2*(2*q3+q4))+q3*(-Q2^2*(q3-10*q4)-...
                18*Q2*q3*q4+2*Q1^2*(-q3+q4)+3*q3*q4*(2*q3+q4))+2*q2*(2*Q2*q3*(5*q3-2*q4)+...
                Q1^2*(q3-q4)+Q2^2*(-4*q3+q4)-q3*(3*q3^2-q3*q4+q4^2))+4*q1*(q2^2*(q3-q4)+...
                Q1*q3*(q3-q4)+q2*(3*Q2^2-Q1*q3-6*Q2*q3+2*q3^2+Q1*q4+q4^2)-q4*(3*Q2^2-6*Q2*q3+...
                q3*(2*q3+q4))))+2*q1*q2*Q2*q3*r1(cnt1)-2*q1*Q2*q3^2*r1(cnt1)-2*q1*q2*Q2*q4*r1(cnt1)+...
                2*q1*Q2*q3*q4*r1(cnt1)+12*q1*Q1*q2*q3*r2(cnt1)-2*Q1*q2^2*q3*r2(cnt1)-10*Q1*q2*q3^2*r2(cnt1)-...
                Q1*q2^2*q4*r2(cnt1)-12*q1*Q1*q3*q4*r2(cnt1)+4*Q1*q2*q3*q4*r2(cnt1)+9*Q1*q3^2*q4*r2(cnt1)-...
                Q1*Q2*(4*q1-q2-3*q3)*(q2-q3)*(q3-q4)*mx)/...
                (3*Q1*Q2*(-(q2+q3)^2+4*q1*(q2-q4)+4*q3*q4));

            p4(cnt1) = (mn*Q1*(q1-q2)*Q2*(q2-q3)*(q3-q4)+c*Q1*Q2*(q1^2*(q2-q3)*(q3-q4)+...
                q2*(-(7*Q2-3*q3)*(Q2-q3)*q3+Q1^2*(q3-q4)+(Q2+q3)^2*q4-4*q3*q4^2)+...
                q2^2*(-3*Q2^2-3*q3^2+2*q3*q4-2*q4^2+2*Q2*(q3+2*q4))+...
                q3*(Q1^2*(-q3+q4)-6*Q2*q4*(q3+2*q4)+Q2^2*(-2*q3+11*q4)+...
                3*q4*(q3^2+2*q4^2))+2*q1*(q2^2*(q3-q4)+Q1*q3*(q3-q4)-...
                q4*(6*Q2^2+2*q3^2+q3*q4+3*q4^2-6*Q2*(q3+q4))+q2*...
                (6*Q2^2-Q1*q3+2*q3^2+Q1*q4+4*q4^2-6*Q2*(q3+q4))))+...
                q1*q2*Q2*q3*r1(cnt1)-q1*Q2*q3^2*r1(cnt1)-q1*q2*Q2*q4*r1(cnt1)+q1*Q2*q3*...
                q4*r1(cnt1)+6*q1*Q1*q2*q3*r2(cnt1)-Q1*q2^2*q3*r2(cnt1)-5*Q1*q2*q3^2*r2(cnt1)+...
                6*q1*Q1*q2*q4*r2(cnt1)-2*Q1*q2^2*q4*r2(cnt1)-6*q1*Q1*q3*q4*r2(cnt1)-Q1*q2*q3*q4*r2(cnt1)+...
                3*Q1*q3^2*q4*r2(cnt1)-6*q1*Q1*q4^2*r2(cnt1)+6*Q1*q3*q4^2*r2(cnt1)-2*Q1*Q2*(q3-q4)*...
                (-q2*(q2+2*q3)+q1*(4*q2-q3-3*q4)+3*q3*q4)*mx)/...
                (3*Q1*Q2*(-(q2+q3)^2+4*q1*(q2-q4)+4*q3*q4));

            d1(cnt1) = (((p2(cnt1)-p1(cnt1))/(q2-q1))-mn)/(mx-mn);
            d2(cnt1) = (((p3(cnt1)-p2(cnt1))/(q3-q2))-((p2(cnt1)-p1(cnt1))/(q2-q1)))/(mx-mn);
            d3(cnt1) = (((p4(cnt1)-p3(cnt1))/(q4-q3)) - ((p3(cnt1)-p2(cnt1))/(q3-q2)))/(mx-mn);
            d4(cnt1) = (mx - ((p4(cnt1)-p3(cnt1))/(q4-q3)))/(mx-mn);
            D1(cnt1) = d1(cnt1);
            D2(cnt1)= d2(cnt1)+d3(cnt1)+d4(cnt1);
            BU1(cnt1) = d1(cnt1)*(p1(cnt1)-(q1/Q1*r1(cnt1)+c*(q1-Q1)^2));
            BU2(cnt1) = d2(cnt1)*(p2(cnt1)-(q2/Q2*r2(cnt1)+c*(q2-Q2)^2));
            BU3(cnt1) = d3(cnt1)*(p3(cnt1)-(q3/Q2*r2(cnt1)+c*(q3-Q2)^2));
            BU4(cnt1) = d4(cnt1)*(p4(cnt1)-(q4/Q2*r2(cnt1)+c*(q4-Q2)^2));
            SU1(cnt1) = (d1(cnt1)*q1/Q1)*(r1(cnt1)-k1);
            SU2(cnt1) = (d2(cnt1)*q2/Q2+d3(cnt1)*q3/Q2+d4(cnt1)*q4/Q2)*(r2(cnt1)-k2);

         
         end
         cnt1 = cnt1+1;
         
     end
     cnt1 = 1;
     figure(1)
     subplot(1,3,n)
%      aa(n) = plot( q2+1:step:q3h, BU1,'b','LineWidth',3);
%      hold on
     bb(n) =plot( q2+1:step:q3h, BU2,'r','LineWidth',3);
     hold on
     cc(n) =plot( q2+1:step:q3h, BU3,'k','LineWidth',3);
     hold on
%      dd(n) =plot( q2+1:step:q3h,BU4,'c','LineWidth',3);
%      hold on
    tit = sprintf(' Brokers Profit, q_1 = %d, q_4 = %d,  q_2 = %d', q1,q4,q2);
    legend('B_2','B_3');
    xlabel('Quality of service offered by B_3');
    title(tit,'FontName','Times','fontsize',16,'fontweight','b');
    set(gca,'FontName','Times','fontsize',16,'fontweight','b') ;
% %     subplot(2,3,5)
    figure(2)
    subplot(1,3,n)
    ff(n) =plot( q2+1:step:q3h,r1,'b','LineWidth',3);
    hold on
%     subplot(2,3,6)
    gg(n) =plot( q2+1:step:q3h,r2,'r','LineWidth',3);
    tit = sprintf(' Providers Price, q_1 = %d, q_4 = %d,  q_2 = %d', q1,q4,q2);
    legend('S_1','S_2');
    xlabel('Quality of service offered by B_3');
    title(tit,'FontName','Times','fontsize',16,'fontweight','b');
    set(gca,'FontName','Times','fontsize',16,'fontweight','b') ;
    hold on
    figure(3)
    subplot(1,3,n)
    gg(n) = plot( q2+1:step:q3h, p1,'b','LineWidth',3);
    hold on

    hh(n) =plot( q2+1:step:q3h, p2,'r','LineWidth',3);
    hold on

    ii(n) =plot( q2+1:step:q3h, p3,'k','LineWidth',3);
    hold on

    jj(n) =plot( q2+1:step:q3h,p4,'c','LineWidth',3);
    hold on
    tit = sprintf(' Brokers Price, q_1 = %d, q_4 = %d,  q_2 = %d', q1,q4,q2);
    legend('B_1','B_2','B_3','B_4');
    xlabel('Quality of service offered by B_3');
    title(tit,'FontName','Times','fontsize',16,'fontweight','b')
    set(gca,'FontName','Times','fontsize',16,'fontweight','b') 
    
    
    
    figure(4)
    subplot(1,3,n)
    fq(n) =plot( q2+1:step:q3h,SU1,'b','LineWidth',3);
    hold on
    gq(n) =plot( q2+1:step:q3h,SU2,'r','LineWidth',3);
    hold on
    tit =  sprintf(' Providers Profit, q_1 = %d, q_4 = %d,  q_2 = %d', q1,q4,q2);
    legend('S_1','S_2');
    xlabel('Quality of service offered by B_3');
    title(tit,'FontName','Times','fontsize',16,'fontweight','b')
    set(gca,'FontName','Times','fontsize',16,'fontweight','b') 
    
    
    
    figure(5)
    subplot(1,3,n)
    eg(n) = plot( q2+1:step:q3h, d1,'b','LineWidth',3);
    hold on
    eh(n) =plot( q2+1:step:q3h, d2,'r','LineWidth',3);
    hold on
    ei(n) =plot( q2+1:step:q3h, d3,'k','LineWidth',3);
    hold on
    ej(n) =plot( q2+1:step:q3h,d4,'c','LineWidth',3);
    tit = sprintf(' Demand of Brokers,  q_1 = %d, q_4 = %d,  q_2 = %d', q1,q4,q2);
    legend('B_1','B_2','B_3','B_4');
    xlabel('Quality of service offered by B_3');
    title(tit,'FontName','Times','fontsize',16,'fontweight','b')
    set(gca,'FontName','Times','fontsize',16,'fontweight','b') 
    hold on
    
    
     figure(6)
     subplot(1,3,n)
    fe(n) =plot( q2+1:step:q3h,D1,'b','LineWidth',3);
    hold on
%     subplot(2,3,6)
    ge(n) =plot( q2+1:step:q3h,D2,'r','LineWidth',3);
    tit = sprintf(' Demand of Providers,   q_1 = %d, q_4 = %d,  q_2 = %d', q1,q4,q2);
    legend('S_1','S_2');
    xlabel('Quality of service offered by B_3');
    title(tit,'FontName','Times','fontsize',16,'fontweight','b');
    set(gca,'FontName','Times','fontsize',16,'fontweight','b') ;
    hold on
    
    n = n+1; 
     
     
     
     
 end
%     legend(aa,legendInfo)